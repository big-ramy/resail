const translations={"ar":{"summary_email_required": "الرجاء إدخال بريدك الإلكتروني في حقل النبذة للمتابعة.","image-paths":{"normal":(id)=>`CV templates_ar/${id}.webp`,"standard":(id)=>`CV templates_ar/${id}.webp`,"professional":(id)=>`CV templates_ar/${id}.webp`,"ast":(id)=>`CV templates_ar/${id}.webp`},"Please fill in all fields.":"الرجاء ملء جميع الحقول المطلوبة.","Please enter a valid email.":"الرجاء إدخال عنوان بريد إلكتروني صالح.","File size exceeds the limit (3MB).":"حجم الملف يتجاوز الحد المسموح به (3 ميجابايت).","Please attach only image or PDF files.":"الرجاء إرفاق ملفات صور أو PDF فقط.","An error occurred while preparing your payment. Please try again or contact support.":"حدث خطأ أثناء تحضير عملية الدفع. يرجى المحاولة مرة أخرى أو الاتصال بالدعم.","Error, price for this category is undefined.":"حدث خطأ، السعر لهذه الفئة غير محدد.","Please select a valid image file.":"الرجاء اختيار ملف صورة صالح.","Image size is too large. Please select an image smaller than {size} megabytes.":"حجم الصورة كبير جداً. الرجاء اختيار صورة أصغر من {size} ميغابايت.","You must have at least one field in this section.":"يجب أن يكون لديك حقل واحد على الأقل في هذا القسم.","payment-success":"تم استلام طلبك بنجاح! سيتم إرسال السيرة الذاتية إلى بريدك الإلكتروني قريباً.","Error processing file.":"حدث خطأ أثناء معالجة الملف.","CV downloaded successfully!":"تم تنزيل السيرة الذاتية بنجاح!","Submitting...":"جاري الإرسال...","please_wait_and_do_not_refresh":"الرجاء عدم إغلاق أو تحديث الصفحة...","loading-cv-text":"جاري إنشاء السيرة الذاتية، يرجى الانتظار...","payment_processing":"جاري معالجة الدفع، يرجى الانتظار...","pdf_generation_in_progress":"جاري تحضير ملف الـ PDF...","preparing_secure_payment":"جاري تحضير عملية الدفع الآمنة...","from-city":"من","notification-action":"يقوم الان بإنشاء سيرته الذاتية!","Career Objective":"الهدف الوظيفي","Work Experience":"الخبرة العملية","Education":"المؤهلات العلمية","Skills":"المهارات","Languages":"اللغات","References":"المراجع","Job Title_placeholder":"المسمى الوظيفي","Company":"الشركة","Duration":"المدة","Description":"الوصف","Degree":"الشهادة","University/Institution":"الجامعة/المعهد","Enter a skill":"أدخل مهارة","Select Level":"اختر المستوى","Beginner":"مبتدئ","Intermediate":"متوسط","Advanced":"متقدم","Expert":"خبير","Enter a language":"أدخل لغة","Name":"الاسم","Position":"الموقع","Phone":"الهاتف","Email":"البريد","custom_section_placeholder":"عنوان القسم الجديد (مثال: المشاريع أو الدورات)","add_subsection_btn":"<i class=\"fas fa-plus\"></i> إضافة عنوان فرعي","remove_subsection_title":"حذف العنوان الفرعي","subsection_title_placeholder":"العنوان الفرعي (مثال: شهادة PMP)","subsection_desc_placeholder":"الوصف أو التفاصيل المتعلقة بالعنوان الفرعي...","remove_section_btn":"حذف القسم بالكامل","confirm_delete_section":"هل أنت متأكد من حذف هذا القسم بالكامل؟","accordion_image_controls":"🖼️ التحكم بالصورة الشخصية","image_size_label":"حجم الصورة","image_radius_label":"شكل الإطار (Radius)","accordion_font_controls":"✒️ التحكم بالخطوط","select_name_font_label":"خط الاسم الرئيسي:","select_headings_font_label":"خط العناوين:","select_body_font_label":"خط النص الأساسي:","accordion_size_controls":"📏 التحكم بأحجام النصوص","name_size_label":"حجم الاسم","title_size_label":"حجم المسمى الوظيفي","contact_size_label":"حجم معلومات الاتصال","section_title_size_label":"حجم عناوين الأقسام","subsection_title_size_label":"حجم العناوين الفرعية","body_text_size_label":"حجم النص الأساسي","accordion_color_controls":"🎨 التحكم بالألوان","color_presets_titl":"إعدادات الألوان المسبقة","color_customization_title":"تخصيص ألوان القالب","background_colors_title":"ألوان الخلفيات","primary_bg_label":"الخلفية الأساسية / الرأس","sidebar_bg_label":"خلفية العامود الجانبي","accent_bg_label":"خلفية مميزة / للمهارات","gradient_label":"متدرج","text_colors_title":"ألوان النصوص والأيقونات","header_text_label":"نص الرأس","title_text_label":"نص العناوين","body_text_label":"نص المحتوى","subtle_text_label":"نص فرعي","gradient_horizontal":"أفقي","gradient_vertical":"عمودي","gradient_diagonal":"قطري","ai_generating_cv": "جاري إنشاء السيرة الذاتية بالذكاء الاصطناعي...","error_name_title_required": "الرجاء إدخال اسم وعنوان الوظيفة للبدء.","ai_error_network": "تعذر الاتصال بالخادم. الرجاء التحقق من اتصالك بالإنترنت والمحاولة مرة أخرى.","ai_error_ratelimit": "هناك ضغط كبير على الخدمة حالياً. الرجاء الانتظار لمدة دقيقة ثم المحاولة مرة أخرى.","ai_error_parsing": "حدث خطأ أثناء معالجة رد الذكاء الاصطناعي. قد يكون الرد غير مكتمل. يرجى المحاولة مجدداً.","ai_error_generic": "حدث خطأ غير متوقع. يرجى المحاولة مرة أخرى أو التواصل مع الدعم الفني.",},"en":{"summary_email_required": "Please enter your email address in the summary field to continue.","image-paths":{"normal":(id)=>`CV templates_en/${id}.webp`,"standard":(id)=>`CV templates_en/${id}.webp`,"professional":(id)=>`CV templates_en/${id}.webp`,"ast":(id)=>`CV templates_en/${id}.webp`},"Please fill in all fields.":"Please fill in all required fields.","Please enter a valid email.":"Please enter a valid email address.","File size exceeds the limit (3MB).":"File size exceeds the 3MB limit.","Please attach only image or PDF files.":"Please attach only image or PDF files.","An error occurred while preparing your payment. Please try again or contact support.":"An error occurred while preparing your payment. Please try again or contact support.","Error, price for this category is undefined.":"Error, price for this category is undefined.","Please select a valid image file.":"Please select a valid image file.","Image size is too large. Please select an image smaller than {size} megabytes.":"Image size is too large. Please select an image smaller than {size} megabytes.","You must have at least one field in this section.":"You must have at least one field in this section.","payment-success":"Your request has been successfully received! The CV will be sent to your email shortly.","Error processing file.":"Error processing file.","CV downloaded successfully!":"CV downloaded successfully!","Submitting...":"Submitting...","please_wait_and_do_not_refresh":"Please do not close or refresh the page...","loading-cv-text":"Generating CV, please wait...","payment_processing":"Processing payment, please wait...","pdf_generation_in_progress":"Preparing the PDF file...","preparing_secure_payment":"Preparing secure payment...","from-city":"from","notification-action":"is creating CV now!","Career Objective":"Career Objective","Work Experience":"Work Experience","Education":"Education","Skills":"Skills","Languages":"Languages","References":"References","Job Title_placeholder":"Job Title","Company":"Company","Duration":"Duration","Description":"Description","Degree":"Degree","University/Institution":"University/Institution","Enter a skill":"Enter a skill","Select Level":"Select Level","Beginner":"Beginner","Intermediate":"Intermediate","Advanced":"Advanced","Expert":"Expert","Enter a language":"Enter a language","Name":"Name","Position":"Position","Phone":"Phone","Email":"Email","custom_section_placeholder":"New Section Title (e.g., Projects or Courses)","add_subsection_btn":"<i class=\"fas fa-plus\"></i> Add Sub-heading","remove_subsection_title":"Remove Sub-heading","subsection_title_placeholder":"Sub-heading (e.g., PMP Certificate)","subsection_desc_placeholder":"Description or details related to the sub-heading...","remove_section_btn":"Delete Entire Section","confirm_delete_section":"Are you sure you want to delete this entire section?","accordion_image_controls":"🖼️ Profile Picture Controls","image_size_label":"Image Size","image_radius_label":"Frame Shape (Radius)","accordion_font_controls":"✒️ Font Controls","select_name_font_label":"Main Name Font:","select_headings_font_label":"Headings Font:","select_body_font_label":"Body Text Font:","accordion_size_controls":"📏 Text Size Controls","name_size_label":"Name Size","title_size_label":"Job Title Size","contact_size_label":"Contact Info Size","section_title_size_label":"Section Titles Size","subsection_title_size_label":"Subsection Titles Size","body_text_size_label":"Body Text Size","accordion_color_controls":"🎨 Color Controls","color_presets_titl":"Color Presets","color_customization_title":"Customize Template Colors","background_colors_title":"Background Colors","primary_bg_label":"Primary BG / Header","sidebar_bg_label":"Sidebar BG","accent_bg_label":"Accent / Skills BG","gradient_label":"Gradient","text_colors_title":"Text & Icon Colors","header_text_label":"Header Text","title_text_label":"Titles Text","body_text_label":"Body Text","subtle_text_label":"Subtle Text","gradient_horizontal":"Horizontal","gradient_vertical":"Vertical","gradient_diagonal":"Diagonal","ai_generating_cv": "Generating CV with AI...","error_name_title_required": "Please enter a name and job title to start.", "ai_error_network": "Could not connect to the server. Please check your internet connection and try again.","ai_error_ratelimit": "The service is currently under high load. Please wait a minute and try again.","ai_error_parsing": "An error occurred while processing the AI response. The response may be incomplete. Please try again.","ai_error_generic": "An unexpected error occurred. Please try again or contact support.",}};const CONTROL_VISIBILITY_CONFIG={'normal':['primary-bg','header-text','title-text','body-text','subtle-text','accent-bg'],'standard':['primary-bg','sidebar-bg','header-text','title-text','body-text','subtle-text','accent-bg'],'professional':['primary-bg','sidebar-bg','header-text','title-text','body-text','subtle-text','accent-bg'],'ast':['primary-bg','sidebar-bg','header-text','title-text','body-text','subtle-text','accent-bg'],'creative':['primary-bg','sidebar-bg','header-text','title-text','body-text','subtle-text','accent-bg']};const colorPalettes=[{name:'Ocean Blue',id:'palette-ocean',isGradient:!1,colors:{'--primary-bg':'#0d47a1','--secondary-bg':'#1976d2','--sidebar-bg':'#f4f6f8','--accent-bg':'#bbdefb','--header-text':'#ffffff','--title-text':'#0d47a1','--body-text':'#333333','--subtle-text':'#5f6368'}},{name:'Forest Green',id:'palette-forest',isGradient:!1,colors:{'--primary-bg':'#1b5e20','--secondary-bg':'#388e3c','--sidebar-bg':'#f5f5f5','--accent-bg':'#c8e6c9','--header-text':'#ffffff','--title-text':'#1b5e20','--body-text':'#212121','--subtle-text':'#616161'}},{name:'Graphite & Amber',id:'palette-graphite',isGradient:!1,colors:{'--primary-bg':'#263238','--secondary-bg':'#37474f','--sidebar-bg':'#f5f5f5','--accent-bg':'#ffecb3','--header-text':'#ffffff','--title-text':'#ffab00','--body-text':'#212121','--subtle-text':'#757575'}},{name:'Ruby Red',id:'palette-ruby',isGradient:!1,colors:{'--primary-bg':'#b71c1c','--secondary-bg':'#d32f2f','--sidebar-bg':'#fbe9e7','--accent-bg':'#ffcdd2','--header-text':'#ffffff','--title-text':'#b71c1c','--body-text':'#424242','--subtle-text':'#757575'}},{name:'Royal Purple',id:'palette-purple',isGradient:!1,colors:{'--primary-bg':'#4a148c','--secondary-bg':'#7b1fa2','--sidebar-bg':'#f3e5f5','--accent-bg':'#e1bee7','--header-text':'#ffffff','--title-text':'#4a148c','--body-text':'#311b92','--subtle-text':'#6a1b9a'}},{name:'Earth Tones',id:'palette-earth',isGradient:!1,colors:{'--primary-bg':'#4e342e','--secondary-bg':'#6d4c41','--sidebar-bg':'#efebe9','--accent-bg':'#d7ccc8','--header-text':'#ffffff','--title-text':'#4e342e','--body-text':'#3e2723','--subtle-text':'#5d4037'}},{name:'Slate Blue',id:'palette-slate',isGradient:!1,colors:{'--primary-bg':'#455a64','--secondary-bg':'#607d8b','--sidebar-bg':'#eceff1','--accent-bg':'#cfd8dc','--header-text':'#ffffff','--title-text':'#37474f','--body-text':'#263238','--subtle-text':'#546e7a'}},{name:'Teal',id:'palette-teal',isGradient:!1,colors:{'--primary-bg':'#00695c','--secondary-bg':'#00897b','--sidebar-bg':'#e0f2f1','--accent-bg':'#b2dfdb','--header-text':'#ffffff','--title-text':'#004d40','--body-text':'#004d40','--subtle-text':'#00796b'}},{name:'Maroon',id:'palette-maroon',isGradient:!1,colors:{'--primary-bg':'#880e4f','--secondary-bg':'#c2185b','--sidebar-bg':'#fce4ec','--accent-bg':'#f8bbd0','--header-text':'#ffffff','--title-text':'#880e4f','--body-text':'#560027','--subtle-text':'#ad1457'}},{name:'Sunset Fade',id:'palette-sunset',isGradient:!0,colors:{'--primary-bg':'linear-gradient(to right, #8e2de2, #4a00e0)','--secondary-bg':'#4a00e0','--sidebar-bg':'#f3e5f5','--accent-bg':'#d1c4e9','--header-text':'#ffffff','--title-text':'#4a00e0','--body-text':'#333333','--subtle-text':'#673ab7'}},{name:'Oceanic Deep',id:'palette-oceanic',isGradient:!0,colors:{'--primary-bg':'linear-gradient(to right, #005c97, #363795)','--secondary-bg':'#005c97','--sidebar-bg':'#e0f7fa','--accent-bg':'#b2ebf2','--header-text':'#ffffff','--title-text':'#005c97','--body-text':'#004d40','--subtle-text':'#00796b'}},{name:'Mint Fresh',id:'palette-mint',isGradient:!0,colors:{'--primary-bg':'linear-gradient(to right, #26d0ce, #1a2980)','--secondary-bg':'#26d0ce','--sidebar-bg':'#f1f8e9','--accent-bg':'#dcedc8','--header-text':'#ffffff','--title-text':'#1a2980','--body-text':'#33691e','--subtle-text':'#558b2f'}},{name:'Soft Peach',id:'palette-peach',isGradient:!0,colors:{'--primary-bg':'linear-gradient(to right, #ff9a9e, #fad0c4)','--secondary-bg':'#ff9a9e','--sidebar-bg':'#fff5f5','--accent-bg':'#ffcdd2','--header-text':'#ffffff','--title-text':'#e57373','--body-text':'#bf360c','--subtle-text':'#f44336'}},{name:'Lush Green',id:'palette-lush',isGradient:!0,colors:{'--primary-bg':'linear-gradient(to right, #2e7d32, #c8e6c9)','--secondary-bg':'#2e7d32','--sidebar-bg':'#f1f8e9','--accent-bg':'#a5d6a7','--header-text':'#ffffff','--title-text':'#1b5e20','--body-text':'#2e7d32','--subtle-text':'#66bb6a'}},{name:'Night Sky',id:'palette-night',isGradient:!0,colors:{'--primary-bg':'linear-gradient(to right, #2c3e50, #4c5a65)','--secondary-bg':'#2c3e50','--sidebar-bg':'#eceff1','--accent-bg':'#b0bec5','--header-text':'#ffffff','--title-text':'#2c3e50','--body-text':'#37474f','--subtle-text':'#546e7a'}}];const arabicFonts=[{name:'Tajawal (تجوال)',value:"'Tajawal', sans-serif"},{name:'Cairo (القاهرة)',value:"'Cairo', sans-serif"},{name:'Amiri (أميري - كلاسيكي)',value:"'Amiri', serif"},{name:'Almarai (المراعي)',value:"'Almarai', sans-serif"},{name:'Markazi Text (مركزي)',value:"'Markazi Text', serif"},{name:'Lalezar (لاله زار - للعناوين)',value:"'Lalezar', cursive"}];const englishFonts=[{name:'Roboto',value:"'Roboto', sans-serif"},{name:'Lato',value:"'Lato', sans-serif"},{name:'Montserrat',value:"'Montserrat', sans-serif"},{name:'Open Sans',value:"'Open Sans', sans-serif"},{name:'PT Sans',value:"'PT Sans', sans-serif"},{name:'Playfair Display (Serif)',value:"'Playfair Display', serif"},{name:'Noto Serif (Serif)',value:"'Noto Serif', serif"}];function populateFontSelectors(){const isArabic=currentLang==='ar';const fontList=isArabic?arabicFonts:englishFonts;const selectors={name:document.getElementById('font-selector-name'),headings:document.getElementById('font-selector-headings'),body:document.getElementById('font-selector-body')};for(const key in selectors){const selectElement=selectors[key];if(selectElement){selectElement.innerHTML='';fontList.forEach(font=>{const option=document.createElement('option');option.value=font.value;option.textContent=font.name;selectElement.appendChild(option)})}}
if(selectors.name)selectors.name.value=isArabic?"'Cairo', sans-serif":"'Playfair Display', serif";if(selectors.headings)selectors.headings.value=isArabic?"'Tajawal', sans-serif":"'Montserrat', sans-serif";if(selectors.body)selectors.body.value=isArabic?"'Almarai', sans-serif":"'Roboto', sans-serif";applySelectedFonts()}
function setupLanguageToggle(){const langToggleButton=document.getElementById('lang-toggle-btn');if(!langToggleButton)return;if(currentLang==='ar'){langToggleButton.textContent='English';langToggleButton.href='en.html';langToggleButton.onclick=()=>setUserLanguage('en')}else{langToggleButton.textContent='العربية';langToggleButton.href='index.html';langToggleButton.onclick=()=>setUserLanguage('ar')}}
function setUserLanguage(lang){if(lang===currentLang){return}
currentLang=lang;sessionStorage.setItem('userLang',lang);window.location.href=lang==='ar'?'index.html':'en.html'}
function saveCvDataToLocalStorage(){const cvData={name:document.getElementById('name-input')?.value,title:document.getElementById('title-input')?.value,email:document.getElementById('email-input')?.value,phone:document.getElementById('phone-input')?.value,website:document.getElementById('website-input')?.value,objective:document.getElementById('objective-input')?.value,profilePic:profilePicDataUrl,experiences:getExperiencesData(),educations:getEducationsData(),skills:getSkillsData(),languages:getLanguagesData(),references:getReferencesData(),customSections:getCustomSectionsData()};try{localStorage.setItem('resailCvData_'+currentLang,JSON.stringify(cvData))}catch(e){console.error("Error saving to localStorage",e)}}
function loadCvDataFromLocalStorage(){try{const savedDataJSON=localStorage.getItem('resailCvData_'+currentLang);if(!savedDataJSON){return!1}
const savedData=JSON.parse(savedDataJSON);document.getElementById('name-input').value=savedData.name||'';document.getElementById('title-input').value=savedData.title||'';document.getElementById('email-input').value=savedData.email||'';document.getElementById('phone-input').value=savedData.phone||'';document.getElementById('website-input').value=savedData.website||'';document.getElementById('objective-input').value=savedData.objective||'';if(savedData.profilePic){profilePicDataUrl=savedData.profilePic}
document.getElementById('experience-input').innerHTML='';document.getElementById('education-input').innerHTML='';document.getElementById('skills-input').innerHTML='';document.getElementById('languages-input').innerHTML='';document.getElementById('references-input').innerHTML='';const oldCustomContainer=document.getElementById('custom-sections-container');if(oldCustomContainer){oldCustomContainer.innerHTML=''}
savedData.experiences?.forEach(data=>addExperienceField(data));savedData.educations?.forEach(data=>addEducationField(data));savedData.skills?.forEach(data=>addSkillField(data));savedData.languages?.forEach(data=>addLanguageField(data));savedData.references?.forEach(data=>addReferenceField(data));if(savedData.customSections&&savedData.customSections.length>0){savedData.customSections.forEach(sectionData=>{addCustomSection();const allCustomSections=document.querySelectorAll('#custom-sections-container .custom-section-wrapper');const newSection=allCustomSections[allCustomSections.length-1];if(newSection){newSection.querySelector('.custom-section-title').value=sectionData.title;const subSectionsContainer=newSection.querySelector('.sub-sections-container');subSectionsContainer.innerHTML='';sectionData.subSections.forEach(subData=>{const subSectionEntry=document.createElement('div');subSectionEntry.className='custom-subsection-entry border p-2 mb-2 rounded position-relative';subSectionEntry.innerHTML=`
                            <button type="button" class="remove-field" onclick="this.parentElement.remove(); generateCV(document.getElementById('cv-container'));" title="${translations[currentLang]['remove_subsection_title']}">&times;</button>
                            <input type="text" class="form-control mb-2 custom-subsection-title" placeholder="${translations[currentLang]['subsection_title_placeholder']}" value="${subData.title || ''}" oninput="generateCV(document.getElementById('cv-container'));">
                            <textarea class="form-control custom-subsection-description" placeholder="${translations[currentLang]['subsection_desc_placeholder']}" rows="3" oninput="generateCV(document.getElementById('cv-container'));">${subData.description || ''}</textarea>
                        `;subSectionsContainer.appendChild(subSectionEntry)})}})}
updatePageContentLanguage();return!0}catch(e){console.error("Error loading from localStorage",e);localStorage.removeItem('resailCvData_'+currentLang);return!1}}
let currentLang='ar';let selectedTemplate=1;let selectedTemplateCategory='normal';let profilePicDataUrl=null;let selectedPriceToPay=0;let discountApplied=0;const discountCodes={"SAVE10":10,"FIRSTBUY":25,"FREECV":100};const PRICES={local:{normal:19,standard:25,professional:29,ast:29,creative:33},lemonSqueezy:{normal:25,standard:33,professional:39,ast:39,creative:45},};const CHECKOUT_CONFIG={normal:{link:'https://resail-cvs.lemonsqueezy.com/buy/bbfff981-9bd9-495c-b1ac-40b013f5b598'},standard:{link:'https://resail-cvs.lemonsqueezy.com/buy/a00ef7a0-db54-47cf-9145-4b5c50892b84?enabled=865702'},professional:{link:'https://resail-cvs.lemonsqueezy.com/buy/fd9e9305-914a-4936-96ed-e308e9ea6460?enabled=865708'},ast:{link:'https://resail-cvs.lemonsqueezy.com/buy/38ead94f-86f2-4f7e-a6eb-e5887f5f0d47?enabled=865714'},creative:{link:'https://resail-cvs.lemonsqueezy.com/buy/c78cce0d-171e-49ff-86dd-5288509cdadc'}};let paymentNameInput,paymentEmailInput,paymentPhoneInput,paymentMessagesInput,paymentFileInput,qrPaymentResultDiv,submitPaymentProofButton,cvContainer,siteHeaderGlobal,loadingOverlayGlobal,loadingTextGlobal;const MAX_FILE_SIZE=3*1024*1024;const ALLOWED_FILE_TYPES=['image/jpeg','image/png','application/pdf'];const NODE_SERVER_URL='https://resail-cv-generator-f0jc.onrender.com';const GOOGLE_APPS_SCRIPT_WEB_APP_URL_PAYMENT_PROCESSOR='https://script.google.com/macros/s/AKfycbxxkX4jsV4zSz4vR7FcCOhYJmXXuOAt5WrJYgZmhTlmO7dzqXARLM6q_5QNo2KVs8bWww/exec';let salesQueue=[{name:"محمد",city:"الرياض"},{name:"سارة",city:"جدة"},{name:"عبدالرحمن",city:"الدمام"}];let finalPriceToPay=0;let appliedCode="";function applySelectedFonts(){const nameFont=document.getElementById('font-selector-name')?.value;const headingsFont=document.getElementById('font-selector-headings')?.value;const bodyFont=document.getElementById('font-selector-body')?.value;const cvContainer=document.getElementById('cv-container');if(!cvContainer||!nameFont||!headingsFont||!bodyFont)return;let livePreviewStyle=document.getElementById('live-font-styles');if(!livePreviewStyle){livePreviewStyle=document.createElement('style');livePreviewStyle.id='live-font-styles';document.head.appendChild(livePreviewStyle)}
livePreviewStyle.textContent=`
        /* تطبيق خط النص الأساسي على الحاوية وعناصر الاتصال */
        #cv-container, #cv-container .cv-contact-item p { font-family: ${bodyFont}; }
        /* تجاوز الخط لاسم الشخص وعنوانه الوظيفي */
        #cv-container .cv-name, #cv-container .cv-title { font-family: ${nameFont}; }
        /* تجاوز الخط لعناوين الأقسام */
        #cv-container .cv-section-title { font-family: ${headingsFont}; }
    `}
function createPaletteControls(){const container=document.getElementById('palette-selector');if(!container)return;container.innerHTML='';const showGradientPalettes=!['normal','standard'].includes(selectedTemplateCategory);colorPalettes.forEach(palette=>{if(palette.isGradient&&!showGradientPalettes){return}
const swatch=document.createElement('div');swatch.className='palette-swatch';swatch.dataset.paletteId=palette.id;const primaryCircle=`<span class="palette-color" style="background: ${palette.colors['--primary-bg']};"></span>`;const titleCircle=`<span class="palette-color" style="background: ${palette.colors['--title-text']};"></span>`;const accentCircle=`<span class="palette-color" style="background: ${palette.colors['--accent-bg']};"></span>`;swatch.innerHTML=`${primaryCircle}${titleCircle}${accentCircle}`;swatch.onclick=()=>applyPalette(palette.id);container.appendChild(swatch)})}
function applyPalette(paletteId){const selectedPalette=colorPalettes.find(p=>p.id===paletteId);if(!selectedPalette)return;const colors=selectedPalette.colors;for(const[key,value]of Object.entries(colors)){const controlName=key.replace('--','');const component=document.querySelector(`.color-control-component[data-color-name="${controlName}"]`);if(component){const toggle=component.querySelector('.gradient-toggle');const solidPicker=component.querySelector(`#color-picker-${controlName}`);const startPicker=component.querySelector(`#color-picker-${controlName}-start`);const endPicker=component.querySelector(`#color-picker-${controlName}-end`);if(typeof value==='string'&&value.startsWith('linear-gradient')){if(!toggle.checked)toggle.click();const colorValues=value.match(/#([0-9a-fA-F]{6}|[0-9a-fA-F]{3})/g);if(colorValues&&colorValues.length>=2){startPicker.value=colorValues[0];endPicker.value=colorValues[1]}}else{if(toggle.checked)toggle.click();solidPicker.value=value}}else{const textPicker=document.getElementById(`color-picker-${controlName}`);if(textPicker)textPicker.value=value}}
document.querySelectorAll('.palette-swatch').forEach(s=>s.classList.remove('selected'));document.querySelector(`.palette-swatch[data-palette-id="${paletteId}"]`).classList.add('selected');applySelectedColors()}
function updateTranslationsForPalette(){const title=document.querySelector('#palette-container h6');if(title){title.textContent=translations[currentLang].color_presets_title}}
async function updateCounters(){const cvCounterElement=document.getElementById('cv-counter-span');const visitorCounterElement=document.getElementById('visitor-counter-span');if(!cvCounterElement||!visitorCounterElement){return}
try{const response=await fetch(`${GOOGLE_APPS_SCRIPT_WEB_APP_URL_PAYMENT_PROCESSOR}?action=getCounters`);if(!response.ok){throw new Error('Network response was not ok')}
const data=await response.json();if(data.status==='success'){const locale=currentLang==='ar'?'ar-EG':'en-US';cvCounterElement.textContent=`+${data.cvCount.toLocaleString(locale)}`;visitorCounterElement.textContent=`+${data.visitorCount.toLocaleString(locale)}`}}catch(error){console.error('Failed to fetch counters:',error)}}

// ▼▼▼ الكود الجديد والنهائي لدالة applyDynamicSizes ▼▼▼
function applyDynamicSizes() {
    const cvContainer = document.getElementById('cv-container');
    if (!cvContainer) return;

    const isMobileView = window.innerWidth <= 992;
    const isZoomedIn = cvContainer.classList.contains('zoomed-in');
    const isScaledDown = isMobileView && !isZoomedIn;
    const visualMultiplier = 3.5;

    const calculateFinalValue = (sliderId, baseValue) => {
        const slider = document.getElementById(sliderId);
        if (!slider) return baseValue;
        const currentValue = parseFloat(slider.value);
        if (isScaledDown) {
            const difference = currentValue - baseValue;
            return baseValue + (difference * visualMultiplier);
        }
        return currentValue;
    };

    // ✨✨✨ التعديل الجوهري هنا ✨✨✨
    // هذه النسخة الجديدة تستخدم setProperty مع 'important' لتجاوز أي أنماط أخرى
    const applyStyleToElements = (selector, styleProperty, value, unit = 'em') => {
        try {
            const elements = cvContainer.querySelectorAll(selector);
            elements.forEach(el => {
                el.style.setProperty(styleProperty, `${value}${unit}`, 'important');
            });
        } catch (e) {
            console.error(`خطأ في تطبيق النمط على المحدد: ${selector}`, e);
        }
    };

    // حساب القيم
    const nameSize = calculateFinalValue('name-size-slider', 2.5);
    const titleSize = calculateFinalValue('title-size-slider', 1.3);
    const contactSize = calculateFinalValue('contact-size-slider', 0.95);
    const sectionTitleSize = calculateFinalValue('section-title-size-slider', 1.2);
    const subsectionTitleSize = calculateFinalValue('subsection-title-size-slider', 1.05);
    const bodyTextSize = calculateFinalValue('body-text-size-slider', 0.9);

    // تطبيق حجم الصورة والإطار
    const imageSize = document.getElementById('image-size-slider')?.value;
    const imageRadius = document.getElementById('image-radius-slider')?.value;
    if (imageSize) cvContainer.style.setProperty('--image-size', `${imageSize}px`);
    if (imageRadius) cvContainer.style.setProperty('--image-radius', `${imageRadius}%`);

    // تطبيق حجم الخطوط مع خاصية important!
    applyStyleToElements('.cv-name', 'font-size', nameSize);
    applyStyleToElements('.cv-title', 'font-size', titleSize);
    applyStyleToElements('.cv-contact-item, .cv-contact-item p', 'font-size', contactSize);
    applyStyleToElements('.cv-section-title', 'font-size', sectionTitleSize);
    
    const subsectionSelectors = ['.cv-job-title', '.cv-degree', '.custom-subsection-title', '.cv-reference-item h4'].join(', ');
    applyStyleToElements(subsectionSelectors, 'font-size', subsectionTitleSize);
    
    const bodySelectors = ['#objective p', '.cv-experience-item p', '.cv-company', '.cv-institution', '.cv-duration', '.skill-name', '.cv-language-list li', '.cv-reference-item p', '.custom-subsection-description'].join(', ');
    applyStyleToElements(bodySelectors, 'font-size', bodyTextSize);
}
function setupDynamicControlListeners(){const sliders=['image-size-slider','image-radius-slider','name-size-slider','title-size-slider','contact-size-slider','section-title-size-slider','subsection-title-size-slider','body-text-size-slider'];sliders.forEach(sliderId=>{const slider=document.getElementById(sliderId);if(slider){slider.addEventListener('input',applyDynamicSizes)}})}
function getColorVariablesAsCssText(){let cssText='#cv-container {';document.querySelectorAll('.color-control-component').forEach(component=>{const colorName=component.dataset.colorName;const toggle=component.querySelector('.gradient-toggle');let finalValue;if(toggle&&toggle.checked){const start=component.querySelector(`#color-picker-${colorName}-start`).value;const end=component.querySelector(`#color-picker-${colorName}-end`).value;const direction=component.querySelector('.gradient-direction').value;finalValue=`linear-gradient(${direction}, ${start}, ${end})`}else{finalValue=component.querySelector(`#color-picker-${colorName}`).value}
cssText+=`--${colorName}: ${finalValue};`});cssText+=`--header-text: ${document.getElementById('color-picker-header-text').value};`;cssText+=`--title-text: ${document.getElementById('color-picker-title-text').value};`;cssText+=`--body-text: ${document.getElementById('color-picker-body-text').value};`;cssText+=`--subtle-text: ${document.getElementById('color-picker-subtle-text').value};`;cssText+='}';return cssText}
function applySelectedColors(){let livePreviewStyle=document.getElementById('live-color-styles');if(!livePreviewStyle){livePreviewStyle=document.createElement('style');livePreviewStyle.id='live-color-styles';document.head.appendChild(livePreviewStyle)}
livePreviewStyle.textContent=getColorVariablesAsCssText()}
function setupColorControls(){document.querySelectorAll('.color-control-component').forEach(component=>{const toggle=component.querySelector('.gradient-toggle');const solidPicker=component.querySelector('.solid-color-picker');const gradientControls=component.querySelector('.gradient-controls');if(toggle&&solidPicker&&gradientControls){toggle.addEventListener('change',()=>{solidPicker.style.display=toggle.checked?'none':'block';gradientControls.style.display=toggle.checked?'block':'none';applySelectedColors()})}
component.querySelectorAll('input[type="color"], select').forEach(input=>{input.addEventListener('input',applySelectedColors)})});document.getElementById('color-picker-header-text').addEventListener('input',applySelectedColors);document.getElementById('color-picker-title-text').addEventListener('input',applySelectedColors);document.getElementById('color-picker-body-text').addEventListener('input',applySelectedColors);document.getElementById('color-picker-subtle-text').addEventListener('input',applySelectedColors)}
function updateColorControlVisibility(){const allowedControls=CONTROL_VISIBILITY_CONFIG[selectedTemplateCategory]||[];document.querySelectorAll('#color-picker-container [data-control-for]').forEach(control=>{control.style.display='none'});allowedControls.forEach(controlName=>{const controlElement=document.querySelector(`#color-picker-container [data-control-for="${controlName}"]`);if(controlElement){controlElement.style.display='block'}})}
function updateControlsForCategory(){const cvContainer=document.getElementById('cv-container');if(!cvContainer)return;const isAdvancedCategory=cvContainer.classList.contains('professional-layout')||cvContainer.classList.contains('ast-layout')||cvContainer.classList.contains('creative-layout');document.querySelectorAll('.gradient-toggle-wrapper').forEach(wrapper=>{wrapper.style.display=isAdvancedCategory?'flex':'none';if(!isAdvancedCategory){const toggle=wrapper.querySelector('.gradient-toggle');if(toggle.checked){toggle.checked=!1;toggle.dispatchEvent(new Event('change'))}}})}
document.addEventListener('DOMContentLoaded',()=>{loadingOverlayGlobal=document.getElementById('loading-overlay');loadingTextGlobal=document.querySelector('#loading-overlay p');    const startOverButton = document.getElementById('start-over-btn');
    if (startOverButton) {
        startOverButton.addEventListener('click', handleStartOver);
    }setInitialLanguage();createPaletteControls();loadCvDataFromLocalStorage();updateControlsForCategory();applySelectedColors();setupColorControls();setupDynamicControlListeners();setupZoomControls();setupAiButtonListener();setupModalButtonListener();window.addEventListener('scroll', handleFloatingButtonVisibility);document.getElementById('color-picker-header-text').addEventListener('input',applySelectedColors);document.getElementById('color-picker-title-text').addEventListener('input',applySelectedColors);document.getElementById('color-picker-body-text').addEventListener('input',applySelectedColors);document.getElementById('color-picker-subtle-text').addEventListener('input',applySelectedColors);const nameFontSelector=document.getElementById('font-selector-name');const headingsFontSelector=document.getElementById('font-selector-headings');const bodyFontSelector=document.getElementById('font-selector-body');if(nameFontSelector)nameFontSelector.addEventListener('change',applySelectedFonts);if(headingsFontSelector)headingsFontSelector.addEventListener('change',applySelectedFonts);if(bodyFontSelector)bodyFontSelector.addEventListener('change',applySelectedFonts);document.addEventListener('keydown',function(event){if((event.ctrlKey||event.metaKey)&&event.key==='p'){event.preventDefault();console.log("Ctrl+P pressed. Triggering custom print dialog.");window.print()}});const promoBar=document.getElementById('promo-bar');if(promoBar){const promoBarHeight=promoBar.offsetHeight;document.body.style.paddingTop=`${promoBarHeight}px`}
siteHeaderGlobal=document.querySelector('.site-header');cvContainer=document.getElementById('cv-container');paymentNameInput=document.getElementById("payment-name");paymentEmailInput=document.getElementById("payment-email");paymentPhoneInput=document.getElementById("payment-phone");paymentMessagesInput=document.getElementById("payment-messages");paymentFileInput=document.getElementById("payment-file");qrPaymentResultDiv=document.getElementById("qr-payment-result");submitPaymentProofButton=document.getElementById("submit-payment-proof");const lemonSqueezyButton = document.getElementById('lemon-squeezy-btn'); if (lemonSqueezyButton) {lemonSqueezyButton.addEventListener('click', handleLemonSqueezyPurchase); }document.getElementById('remove-discount-btn').addEventListener('click',(e)=>{e.preventDefault();removeDiscount()});if(submitPaymentProofButton){submitPaymentProofButton.addEventListener('click',submitPaymentProof)}
const cvDataEntryPage = document.getElementById('cv-data-entry-page');
if (cvDataEntryPage) {
    cvDataEntryPage.addEventListener('input', () => {
        saveCvDataToLocalStorage();
        showSaveNotification(); // <-- أضف هذا السطر
    }, true);
}
setInitialLanguage();initializeDiscountCards();populateFontSelectors();startSalesNotifications();updateCounters();initializeCountdown();updateLanguage();showPage('landing-page');lazyLoadImages()});function addCustomSection(){let customSectionsContainer=document.getElementById('custom-sections-container');if(!customSectionsContainer){customSectionsContainer=document.createElement('div');customSectionsContainer.id='custom-sections-container';const formNavigationButtons=document.getElementById('form-navigation-buttons');formNavigationButtons.parentNode.insertBefore(customSectionsContainer,formNavigationButtons)}
const sectionWrapper=document.createElement('div');sectionWrapper.className='custom-section-wrapper mb-3 p-3 border rounded';const titleInput=document.createElement('input');titleInput.type='text';titleInput.placeholder=translations[currentLang].custom_section_placeholder;titleInput.className='form-control form-control-lg mb-2 custom-section-title';titleInput.oninput=()=>generateCV(document.getElementById('cv-container'));const subSectionsContainer=document.createElement('div');subSectionsContainer.className='sub-sections-container';const buttonContainer=document.createElement('div');buttonContainer.className='mt-2';const addSubSectionButton=document.createElement('button');addSubSectionButton.type='button';addSubSectionButton.className='btn btn-sm btn-outline-primary me-2';addSubSectionButton.innerHTML=translations[currentLang].add_subsection_btn;addSubSectionButton.onclick=function(){const subSectionEntry=document.createElement('div');subSectionEntry.className='custom-subsection-entry border p-2 mb-2 rounded position-relative';const removeSubButton=document.createElement('button');removeSubButton.type='button';removeSubButton.className='remove-field';removeSubButton.innerHTML='&times;';removeSubButton.title=translations[currentLang].remove_subsection_title;removeSubButton.onclick=()=>{subSectionEntry.remove();generateCV(document.getElementById('cv-container'))};const subTitleInput=document.createElement('input');subTitleInput.type='text';subTitleInput.className='form-control mb-2 custom-subsection-title';subTitleInput.placeholder=translations[currentLang].subsection_title_placeholder;subTitleInput.oninput=()=>generateCV(document.getElementById('cv-container'));const subDescriptionTextarea=document.createElement('textarea');subDescriptionTextarea.className='form-control custom-subsection-description';subDescriptionTextarea.placeholder=translations[currentLang].subsection_desc_placeholder;subDescriptionTextarea.rows=3;subDescriptionTextarea.oninput=()=>generateCV(document.getElementById('cv-container'));subSectionEntry.appendChild(removeSubButton);subSectionEntry.appendChild(subTitleInput);subSectionEntry.appendChild(subDescriptionTextarea);subSectionsContainer.appendChild(subSectionEntry)};const removeSectionButton=document.createElement('button');removeSectionButton.type='button';removeSectionButton.className='btn btn-sm btn-danger';removeSectionButton.textContent=translations[currentLang].remove_section_btn;removeSectionButton.onclick=function(){if(confirm(translations[currentLang].confirm_delete_section)){sectionWrapper.remove();generateCV(document.getElementById('cv-container'))}};buttonContainer.appendChild(addSubSectionButton);buttonContainer.appendChild(removeSectionButton);sectionWrapper.appendChild(titleInput);sectionWrapper.appendChild(subSectionsContainer);sectionWrapper.appendChild(buttonContainer);customSectionsContainer.appendChild(sectionWrapper);addSubSectionButton.click();sectionWrapper.scrollIntoView({behavior:'smooth',block:'center'})}
function updateTemplateImageSources(){const templateImages=document.querySelectorAll('.template-preview');console.log("Updating template image sources for language:",currentLang);templateImages.forEach(img=>{const templateId=parseInt(img.getAttribute('data-template-id'));const templateCategory=img.getAttribute('data-template-category');if(!isNaN(templateId)&&translations[currentLang]["image-paths"][templateCategory]){const newSrc=translations[currentLang]["image-paths"][templateCategory](templateId);img.src=newSrc;console.log(`Setting image src for id ${templateId} (${templateCategory}) to: ${newSrc}`)}else{console.warn(`Could not set src for image. templateId: ${templateId}, category: ${templateCategory}, lang: ${currentLang}`)}})}
function setInitialLanguage(){const userChosenLang=sessionStorage.getItem('userLang');const path=window.location.pathname;if(userChosenLang){currentLang=userChosenLang;return}
if(path.endsWith('en.html')){currentLang='en'}else if(path.endsWith('index.html')||path.endsWith('/')){currentLang='ar'}else{currentLang='ar'}
sessionStorage.setItem('userLang',currentLang);console.log(`[setInitialLanguage] Language set to: ${currentLang}`)}
function updateAllPriceDisplays(){const category=selectedTemplateCategory;if(!category)return;const originalLocalPrice=PRICES.local[category];const originalLsPrice=PRICES.lemonSqueezy[category];const finalLocalPrice=Math.max(0,Math.round(originalLocalPrice*(1-discountApplied/100)));const finalLsPrice=Math.max(0,Math.round(originalLsPrice*(1-discountApplied/100)));const localPriceElement=document.getElementById('local-price-display');const localCurrencyElement=localPriceElement.nextElementSibling;if(localPriceElement){if(discountApplied>0&&finalLocalPrice<originalLocalPrice){localPriceElement.innerHTML=`<del style="color: #999; font-size: 0.8em;">${originalLocalPrice}</del> ${finalLocalPrice}`}else{localPriceElement.textContent=originalLocalPrice}
if(localCurrencyElement){localCurrencyElement.textContent=translations[currentLang]['sar-currency']}}
const lsPriceElement=document.getElementById('ls-price-display');const lsCurrencyElement=lsPriceElement.nextElementSibling;if(lsPriceElement){if(discountApplied>0&&finalLsPrice<originalLsPrice){lsPriceElement.innerHTML=`<del style="color: #999; font-size: 0.8em;">${originalLsPrice}</del> ${finalLsPrice}`}else{lsPriceElement.textContent=originalLsPrice}
if(lsCurrencyElement){lsCurrencyElement.textContent=translations[currentLang]['sar-currency']}}
finalPriceToPay=finalLocalPrice}
function toggleSiteHeader(show){if(siteHeaderGlobal){siteHeaderGlobal.style.display=show?'flex':'none'}}
function startSalesNotifications(){const notificationElement=document.getElementById('sales-notification');const nameElement=document.getElementById('sales-name');const cityElement=document.getElementById('sales-city');if(!notificationElement||!nameElement||!cityElement)return;fetchRecentSales();setInterval(()=>{if(salesQueue.length===0)return;const sale=salesQueue[Math.floor(Math.random()*salesQueue.length)];nameElement.textContent=sale.name;cityElement.textContent=sale.city;notificationElement.classList.add('show');setTimeout(()=>{notificationElement.classList.remove('show')},5000)},8000)}
async function fetchRecentSales(){try{const response=await fetch(`${GOOGLE_APPS_SCRIPT_WEB_APP_URL_PAYMENT_PROCESSOR}?action=getRecentSales`);const data=await response.json();if(data.status==='success'&&data.sales.length>0){salesQueue=data.sales}}catch(error){console.error("Could not fetch recent sales:",error)}}
function toggleLoadingOverlay(show,messageKey='loading-cv-text'){if(loadingOverlayGlobal&&loadingTextGlobal){if(show){let message=translations[currentLang][messageKey]||messageKey;const warningText=translations[currentLang].please_wait_and_do_not_refresh||'Please do not close or refresh the page...';loadingTextGlobal.innerHTML=`${message}<br><small>${warningText}</small>`;loadingTextGlobal.setAttribute('data-current-key',messageKey);loadingOverlayGlobal.style.display='flex'}else{loadingOverlayGlobal.style.display='none';loadingTextGlobal.removeAttribute('data-current-key')}}}
function updatePaymentOptionsUI(category){if(!category||!PRICES.local[category]||!PRICES.lemonSqueezy[category]){console.error("Invalid category or prices not defined for:",category);return}
const localPriceElement=document.getElementById('local-price-display');const lsPriceElement=document.getElementById('ls-price-display');if(localPriceElement){localPriceElement.textContent=PRICES.local[category]}
if(lsPriceElement){lsPriceElement.textContent=PRICES.lemonSqueezy[category]}}
function removeDiscount(){discountApplied=0;appliedCode="";const codeInput=document.getElementById('discount-code');if(codeInput)codeInput.value="";document.querySelectorAll('.discount-card.selected').forEach(card=>{card.classList.remove('selected')});updateAllPriceDisplays();document.getElementById('remove-discount-container').style.display='none'}

/**
 * =========================================================================
 * == (النسخة النهائية) الدالة الأساسية للتنقل بين الصفحات ومنطق تعبئة البيانات ==
 * =========================================================================
 * @param {string} pageId The ID of the page section to display.
 */
function showPage(pageId) {
    const pages = document.querySelectorAll('.page-section');
    pages.forEach(page => page.classList.remove('active-page'));

    const targetPage = document.getElementById(pageId);
    if (targetPage) {
        targetPage.classList.add('active-page');
        window.scrollTo(0, 0);
        toggleSiteHeader(pageId === 'landing-page');
        updatePageContentLanguage();
        handleFloatingButtonVisibility();
    } else {
        console.error(`Page with ID "${pageId}" not found. Showing landing page.`);
        document.getElementById('landing-page').classList.add('active-page');
        return; 
    }

    // ▼▼▼ المنطق الحاسم عند عرض صفحة إدخال البيانات ▼▼▼
    if (pageId === 'cv-data-entry-page') {
        const aiDataString = sessionStorage.getItem('aiCvData');
        
        // --- 1. التحقق من وجود بيانات جديدة من الذكاء الاصطناعي ---
        if (aiDataString) {
            const aiData = JSON.parse(aiDataString);
            const aiName = sessionStorage.getItem('aiCvUserName');
            const aiTitle = sessionStorage.getItem('aiCvUserTitle');
            const extracted = aiData.extractedInfo || {};
            
            clearAllCvFields(); // مسح أي بيانات قديمة

            // تعبئة النموذج بالبيانات الجديدة
            document.getElementById('name-input').value = aiName || '';
            document.getElementById('title-input').value = aiTitle || '';
            document.getElementById('email-input').value = extracted.email || '';
            document.getElementById('phone-input').value = extracted.phone || '';
            document.getElementById('website-input').value = extracted.city || '';
            document.getElementById('objective-input').value = aiData.objective || '';

            aiData.experiences?.forEach(exp => addExperienceField(exp));
            aiData.education?.forEach(edu => addEducationField(edu));
            aiData.skills?.forEach(skill => addSkillField(skill));
            aiData.languages?.forEach(lang => addLanguageField(lang));
            aiData.customSections?.forEach(section => addCustomSectionFromAI(section));
            aiData.references?.forEach(ref => addReferenceField(ref));

            // *** الخطوة الحاسمة: حفظ البيانات في الذاكرة الدائمة فوراً ***
            saveCvDataToLocalStorage(); 
            
            // مسح البيانات المؤقتة بعد استخدامها وحفظها
            sessionStorage.removeItem('aiCvData');
            sessionStorage.removeItem('aiCvUserName');
            sessionStorage.removeItem('aiCvUserTitle');

        } else {
            // --- 2. إذا لم تكن هناك بيانات جديدة، قم بتحميل البيانات المحفوظة كالمعتاد ---
            const dataWasLoaded = loadCvDataFromLocalStorage();
            if (!dataWasLoaded) {
                 // تعبئة بيانات تجريبية إذا كانت الذاكرة فارغة
            }
        }
        
        generateCV(cvContainer);
        updateProgress();
    }
}


// لا تنس إضافة هذه الدالة المساعدة لمسح الحقول
function clearAllCvFields() {
    document.getElementById('name-input').value = '';
    document.getElementById('title-input').value = '';
    document.getElementById('email-input').value = '';
    document.getElementById('phone-input').value = '';
    document.getElementById('website-input').value = '';
    document.getElementById('objective-input').value = '';
    profilePicDataUrl = null;
    document.getElementById('profile-pic-preview').style.display = 'none';
    document.getElementById('file-name-display').textContent = '';

    ['experience-input', 'education-input', 'skills-input', 'languages-input', 'references-input'].forEach(id => {
        const container = document.getElementById(id);
        if (container) container.innerHTML = '';
    });
    const customContainer = document.getElementById('custom-sections-container');
    if (customContainer) customContainer.remove();
}

function toggleLanguage(){currentLang=currentLang==='ar'?'en':'ar';console.log(`[toggleLanguage] Language toggled to: ${currentLang}`);updateLanguage();updateCounters();if(cvContainer&&(document.getElementById('cv-preview-page').classList.contains('active-page')||document.getElementById('cv-template-selection-page').classList.contains('active-page')||document.getElementById('cv-data-entry-page').classList.contains('active-page'))){generateCV(cvContainer)}}
function updateLanguage(){const isArabic=currentLang==='ar';document.documentElement.lang=currentLang;document.documentElement.dir=isArabic?'rtl':'ltr';if(cvContainer){cvContainer.dir=isArabic?'rtl':'ltr'}
document.body.classList.toggle('rtl',isArabic);document.body.classList.toggle('ltr',!isArabic);updateNavbarLinks();updatePageContentLanguage();updateTemplateImageSources();populateFontSelectors();setupLanguageToggle();updateTranslationsForPalette();if(document.getElementById('cv-data-entry-page')?.classList.contains('active-page')){}}
function updateNavbarLinks(){const links=document.querySelectorAll('nav [data-translate]');links.forEach(link=>{const key=link.getAttribute('data-translate');if(translations[currentLang]&&translations[currentLang][key]!==undefined){link.textContent=translations[currentLang][key]}});const langToggleSpan=document.getElementById('currentLangText');if(langToggleSpan){langToggleSpan.textContent=currentLang==='ar'?translations.en.English:translations.ar.العربية}}
function updatePageContentLanguage(){const isArabic=currentLang==='ar';const allTranslatableElements=document.querySelectorAll('[data-en], [data-ar], [data-translate-id], [data-translate]');if(loadingOverlayGlobal&&loadingOverlayGlobal.style.display==='flex'&&loadingTextGlobal){const currentMessageKey=loadingTextGlobal.getAttribute('data-current-key')||'Generating CV, please wait...';loadingTextGlobal.textContent=translations[currentLang][currentMessageKey]||currentMessageKey}
allTranslatableElements.forEach(element=>{let newContent=null;const translateIdKey=element.getAttribute('data-translate-id');const translateKey=element.getAttribute('data-translate');if(translateIdKey&&translations[currentLang]&&translations[currentLang][translateIdKey]!==undefined){newContent=translations[currentLang][translateIdKey]}else if(translateKey&&translations[currentLang]&&translations[currentLang][translateKey]!==undefined){newContent=translations[currentLang][translateKey]}else{const textKeyAttr=isArabic?element.getAttribute('data-ar'):element.getAttribute('data-en');if(textKeyAttr){if(translations[currentLang]&&translations[currentLang][textKeyAttr]!==undefined){newContent=translations[currentLang][textKeyAttr]}else{newContent=textKeyAttr}}}
if(newContent!==null){if(Array.isArray(newContent)&&element.tagName==='UL'){let listHtml='';newContent.forEach(itemHtml=>{listHtml+=`<li>${itemHtml}</li>`});element.innerHTML=listHtml}else if(typeof newContent==='string'){const containsHtml=/<[a-z][\s\S]*>/i.test(newContent);if(containsHtml){element.innerHTML=newContent}else{if(element.tagName!=='IMG'&&element.tagName!=='INPUT'&&element.tagName!=='TEXTAREA'){element.textContent=newContent}}}}});const placeholderElements=document.querySelectorAll('[data-en-placeholder], [data-ar-placeholder]');placeholderElements.forEach(element=>{const placeholderKey=isArabic?element.getAttribute('data-ar-placeholder'):element.getAttribute('data-en-placeholder');if(placeholderKey&&translations[currentLang]&&translations[currentLang][placeholderKey]!==undefined){element.placeholder=translations[currentLang][placeholderKey]}else if(placeholderKey){element.placeholder=placeholderKey}});const altElements=document.querySelectorAll('[data-en-alt], [data-ar-alt]');altElements.forEach(element=>{if(element.tagName==='IMG'){const altKey=isArabic?element.getAttribute('data-ar-alt'):element.getAttribute('data-en-alt');if(altKey&&translations[currentLang]&&translations[currentLang][altKey]!==undefined){element.alt=translations[currentLang][altKey]}else if(altKey){element.alt=altKey}}});const footerLinks=document.querySelectorAll('footer .list-inline-item a');footerLinks.forEach(link=>{const key=link.getAttribute('data-translate');if(key&&translations[currentLang]&&translations[currentLang][key]!==undefined){link.textContent=translations[currentLang][key]}});const contactEmailLinks=document.querySelectorAll('#contact p strong a, #terms-of-service-page a[href^="mailto:"], #refund-policy a[href^="mailto:"], #privacy-policy a[href^="mailto:"]');contactEmailLinks.forEach(link=>{let key;if(link.closest('#contact')){key='email-address-contact'}else if(link.closest('#terms-of-service-page')){key='terms-of-service-email-contact'}else if(link.closest('#refund-policy')){key='refund-policy-email-contact'}else if(link.closest('#privacy-policy')){key='privacy-policy-email-contact'}
if(key&&translations[currentLang]&&translations[currentLang][key]!==undefined){link.textContent=translations[currentLang][key]}});if(document.getElementById('payment-options-page')?.classList.contains('active-page')){updateAllPriceDisplays()}}
// في ملف script (5).js
// ▼▼▼ استبدل دالة collectCvData القديمة بهذه النسخة المصححة ▼▼▼

function collectCvData() {
    // جمع كل البيانات كما في السابق
    const name = document.getElementById('name-input')?.value.trim();
    const jobTitle = document.getElementById('title-input')?.value.trim();
    const email = document.getElementById('email-input')?.value.trim() || ''; // <-- هذا السطر موجود لديك
    const phone = document.getElementById('phone-input')?.value.trim();
    const website = document.getElementById('website-input')?.value.trim();
    const objective = document.getElementById('objective-input')?.value.trim();
    const experiences = getExperiencesData();
    const educations = getEducationsData();
    const skills = getSkillsData();
    const languages = getLanguagesData();
    const references = getReferencesData();
    const customSections = getCustomSectionsData();

    // بناء كائن البيانات
    const cvData = {
        name: name,
        jobTitle: jobTitle,
        // ▼▼▼  هذا هو السطر الحاسم الذي كان مفقودًا ▼▼▼
        email: email, 
        // ▲▲▲ نهاية السطر الحاسم ▲▲▲
        phone: phone,
        website: website,
        objective: objective,
        experiences: experiences,
        educations: educations,
        skills: skills,
        languages: languages,
        references: references,
        customSections: customSections,
        templateCategory: selectedTemplateCategory,
        templateNumber: selectedTemplate,
        language: currentLang,
        profilePicDataUrl: profilePicDataUrl
    };
    
    // إرجاع الكائن الكامل
    return cvData;
}

// استبدل هذه الدالة بالكامل في ملف script.js
async function handleLemonSqueezyPurchase() {
    toggleLoadingOverlay(true, 'preparing_secure_payment');
    try {
        const cvData = collectCvData();
        const cvPreviewElement = document.getElementById('cv-container');
        if (!cvPreviewElement) throw new Error("CV container not found.");

        // --- بداية الحل الشامل لتجميع كل الأنماط ---

        // 1. جلب ملفات CSS الأساسية من الموقع
        const fetchCss = async (url) => {
            try {
                const response = await fetch(url);
                if (!response.ok) return ''; // تجاهل الملف إذا فشل تحميله
                return response.text();
            } catch (e) { return ''; }
        };
        const [mainCss, templatesCss, responsiveCss] = await Promise.all([
            fetchCss('style.css'), fetchCss('templates.css'), fetchCss('responsive.css')
        ]);
        const staticCssText = mainCss + templatesCss + responsiveCss;

        // 2. دالة جديدة لتجميع أنماط الخطوط والأحجام الديناميكية
        const getDynamicStylesAsCssText = () => {
            let styles = '';
            const isMobileView = window.innerWidth <= 992;
            const isZoomedIn = cvPreviewElement.classList.contains('zoomed-in');
            const isScaledDown = isMobileView && !isZoomedIn;
            const visualMultiplier = 3.5; // نفس القيمة المستخدمة في المعاينة

            const calculateFinalValue = (sliderId, baseValue) => {
                const slider = document.getElementById(sliderId);
                if (!slider) return baseValue;
                const currentValue = parseFloat(slider.value);
                if (isScaledDown) {
                    const difference = currentValue - baseValue;
                    return baseValue + (difference * visualMultiplier);
                }
                return currentValue;
            };

            // جلب قيم الخطوط
            const nameFont = document.getElementById('font-selector-name')?.value || "'Playfair Display', serif";
            const headingsFont = document.getElementById('font-selector-headings')?.value || "'Montserrat', sans-serif";
            const bodyFont = document.getElementById('font-selector-body')?.value || "'Roboto', sans-serif";

            styles += `#cv-container, #cv-container .cv-contact-item p { font-family: ${bodyFont} !important; }`;
            styles += `#cv-container .cv-name, #cv-container .cv-title { font-family: ${nameFont} !important; }`;
            styles += `#cv-container .cv-section-title { font-family: ${headingsFont} !important; }`;

            // جلب قيم الأحجام
            styles += `.cv-name { font-size: ${calculateFinalValue('name-size-slider', 2.5)}em !important; }`;
            styles += `.cv-title { font-size: ${calculateFinalValue('title-size-slider', 1.3)}em !important; }`;
            styles += `.cv-contact-item, .cv-contact-item p { font-size: ${calculateFinalValue('contact-size-slider', 0.95)}em !important; }`;
            styles += `.cv-section-title { font-size: ${calculateFinalValue('section-title-size-slider', 1.2)}em !important; }`;
            
            const subsectionSelectors = ['.cv-job-title', '.cv-degree', '.custom-subsection-title', '.cv-reference-item h4'].join(', ');
            styles += `${subsectionSelectors} { font-size: ${calculateFinalValue('subsection-title-size-slider', 1.05)}em !important; }`;
            
            const bodySelectors = ['#objective p', '.cv-experience-item p', '.cv-company', '.cv-institution', '.cv-duration', '.skill-name', '.cv-language-list li', '.cv-reference-item p', '.custom-subsection-description'].join(', ');
            styles += `${bodySelectors} { font-size: ${calculateFinalValue('body-text-size-slider', 0.9)}em !important; }`;

            return styles;
        };

        const colorVariablesCSS = getColorVariablesAsCssText();
        const dynamicSizeAndFontCSS = getDynamicStylesAsCssText();
        const imageSize = document.getElementById('image-size-slider')?.value || 120;
        const imageRadius = document.getElementById('image-radius-slider')?.value || 50;

        const dynamicCssOverrides = `
            ${colorVariablesCSS}
            #cv-container {
                --image-size: ${imageSize}px;
                --image-radius: ${imageRadius}%;
            }
            ${dynamicSizeAndFontCSS}
        `;
        // --- نهاية الحل الشامل ---

        // 3. بناء الـ HTML النهائي
        const tempContainer = document.createElement('div');
        generateCV(tempContainer);
        const finalHtmlContent = tempContainer.innerHTML;
        tempContainer.remove();
        
        const direction = cvData.language === 'ar' ? 'rtl' : 'ltr';
        const fullPageHtml = `
            <!DOCTYPE html>
            <html lang="${cvData.language}" dir="${direction}">
            <head>
                <meta charset="UTF-8"><title>CV</title>
                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
                <link rel="preconnect" href="https://fonts.googleapis.com">
                <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
                <link href="https://fonts.googleapis.com/css2?family=Almarai&family=Amiri&family=Cairo&family=Lalezar&family=Lato&family=Markazi+Text&family=Montserrat&family=Noto+Serif&family=Open+Sans&family=PT+Sans&family=Playfair+Display&family=Quicksand&family=Roboto&family=Tajawal&family=Ubuntu&display=swap" rel="stylesheet">
                <style>${staticCssText} ${dynamicCssOverrides}</style>
            </head>
            <body>
                 <div id="cv-container" class="${cvData.templateCategory}-layout template${cvData.templateNumber}" dir="${direction}">
                    ${finalHtmlContent}
                 </div>
            </body>
            </html>
        `;

        cvData.fullHtml = fullPageHtml;

        // نضيف بيانات المطابقة إلى نفس الكائن الذي سيتم إرساله إلى سيرفرك
        cvData.userAgent = navigator.userAgent;
        const fbp = getCookie('_fbp');
        if (fbp) cvData.fbp = fbp;
        const fbc = getCookie('_fbc');
        if (fbc) cvData.fbc = fbc;
      
        // 4. إرسال البيانات إلى الخادم (يبقى كما هو)
                const prepareResponse = await fetch(`${NODE_SERVER_URL}/api/prepare-checkout`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(cvData) // الآن cvData يحتوي على كل شيء
        });

        if (!prepareResponse.ok) throw new Error(await prepareResponse.text());

        const { sessionId } = await prepareResponse.json();
        if (!sessionId) throw new Error('Could not retrieve session ID.');
        
        const checkoutConfig = CHECKOUT_CONFIG[selectedTemplateCategory];
        let finalUrl = new URL(checkoutConfig.link);
        finalUrl.searchParams.set('checkout[custom][session_id]', sessionId);
        if (cvData.email) finalUrl.searchParams.set('checkout[email]', cvData.email);
        if (cvData.name) finalUrl.searchParams.set('checkout[name]', cvData.name);
        
        window.location.href = finalUrl.toString();

    } catch (error) {
        console.error('Lemon Squeezy purchase error:', error);
        alert(translations[currentLang]["An error occurred while preparing your payment. Please try again or contact support."]);
        toggleLoadingOverlay(false);
    }
}
function lazyLoadImages(){const lazyImages=document.querySelectorAll('img[data-src]');if('IntersectionObserver' in window){const observer=new IntersectionObserver((entries,observer)=>{entries.forEach(entry=>{if(entry.isIntersecting){const lazyImage=entry.target;lazyImage.src=lazyImage.dataset.src;if(lazyImage.dataset.srcset){lazyImage.srcset=lazyImage.dataset.srcset}
lazyImage.removeAttribute('data-src');lazyImage.removeAttribute('data-srcset');observer.unobserve(lazyImage)}})},{rootMargin:'0px 0px 200px 0px',threshold:0.01});lazyImages.forEach(image=>{observer.observe(image)})}else{lazyImages.forEach(image=>{image.src=image.dataset.src;if(image.dataset.srcset){image.srcset=image.dataset.srcset}
image.removeAttribute('data-src');image.removeAttribute('data-srcset')})}}
function validateAndShowTemplatePage(){showPage('cv-template-selection-page')}
function initializeDiscountCards() {
    const discountCards = document.querySelectorAll('.discount-card');
    const codeInput = document.getElementById('discount-code');

    discountCards.forEach(card => {
        // التعامل مع بطاقة الخصم المجاني بشكل خاص
        if (card.id === 'free-cv-card') {
            card.addEventListener('click', handleFreeCvDownload);
        } else {
            // البطاقات الأخرى تعمل كالمعتاد
            card.addEventListener('click', () => {
                discountCards.forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                const code = card.getAttribute('data-code');
                codeInput.value = code;
                applyDiscountCode();
            });
        }
    });
}
async function applyDiscountCode() {
    const codeInput = document.getElementById("discount-code");
    if (!codeInput) return;
    const code = codeInput.value.trim().toUpperCase();

    if (code && discountCodes[code] !== undefined) {
        discountApplied = discountCodes[code];
        appliedCode = code;
        alert(currentLang === 'ar' ? `تم تطبيق كود الخصم "${code}". سيتم تحديث السعر.` : `Discount code "${code}" applied. The price will be updated.`);
        document.getElementById('remove-discount-container').style.display = 'block';
    } else if (code) {
        removeDiscount();
        alert(currentLang === 'ar' ? 'كود الخصم غير صالح.' : 'Invalid discount code.');
    } else {
        removeDiscount();
    }
    updateAllPriceDisplays();
}
function openPaymentForCV_appsScript() {
    showPage('payment-options-page');
}
function updatePriceDisplay(discountedPrice){const finalPriceText=document.getElementById("final-price-text");if(finalPriceText){const currency=currentLang==='ar'?' ريال':' SAR';finalPriceText.textContent=(translations[currentLang].messages||"Price Paid")+": "+discountedPrice+currency}}
function getDiscountedPrice(){if(discountApplied>0&&discountApplied<=100){return Math.max(0,Math.round(selectedPriceToPay*(1-discountApplied/100)))}
return selectedPriceToPay}
function openQrPaymentPage(method,templateCategory){const originalPrice=PRICES.local[templateCategory];if(originalPrice===undefined){console.error("Price for category not found:",templateCategory);alert("حدث خطأ، السعر لهذه الفئة غير محدد.");return}
const codeInput=document.getElementById("discount-code");const code=codeInput?codeInput.value.trim().toUpperCase():"";let finalPrice=originalPrice;let appliedDiscountCode="";if(code&&discountCodes[code]!==undefined){const discountPercentage=discountCodes[code];finalPrice=Math.max(0,Math.round(originalPrice*(1-discountPercentage/100)));appliedDiscountCode=code}
const qrPaymentImage=document.getElementById("qr-payment-image");const manualPaymentForm=document.getElementById("manual-payment-form");const submitBtn=document.getElementById("submit-payment-proof");const qrPaymentResultDiv=document.getElementById("qr-payment-result");if(qrPaymentImage)qrPaymentImage.style.display="none";if(manualPaymentForm)manualPaymentForm.style.display="none";if(submitBtn)submitBtn.style.display="none";if(qrPaymentResultDiv)qrPaymentResultDiv.textContent='';const mainName=document.getElementById('name-input')?.value.trim();const mainEmail=document.getElementById('email-input')?.value.trim();const mainPhone=document.getElementById('phone-input')?.value.trim();if(paymentNameInput)paymentNameInput.value=mainName;if(paymentEmailInput)paymentEmailInput.value=mainEmail;if(paymentPhoneInput)paymentPhoneInput.value=mainPhone;if(paymentMessagesInput)paymentMessagesInput.value=finalPrice;const qrManualPaymentPage=document.getElementById('qr-manual-payment-page');if(qrManualPaymentPage){qrManualPaymentPage.setAttribute("data-payment-method",method);qrManualPaymentPage.setAttribute("data-discount-code",appliedDiscountCode);qrManualPaymentPage.setAttribute("data-cv-template-category",templateCategory);qrManualPaymentPage.setAttribute("data-price-paid",finalPrice.toString())}
if(method.toLowerCase()==="stc pay"||method.toLowerCase()==="rajhi"){if(qrPaymentImage){qrPaymentImage.src=(method.toLowerCase()==="stc pay")?"QRstcpay.png.webp":"QRalrajhi.png.webp";qrPaymentImage.alt=(method.toLowerCase()==="stc pay")?"STC Pay QR Code":"Al Rajhi QR Code";qrPaymentImage.style.display="block"}
if(manualPaymentForm)manualPaymentForm.style.display="block";if(submitBtn)submitBtn.style.display="block"}
showPage('qr-manual-payment-page')}
function isMobileDevice(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}
// استبدل هذه الدالة بالكامل في ملف الواجهة الأمامية script.js
async function submitPaymentProof(event) {
    event.preventDefault();
    const submitButton = document.getElementById("submit-payment-proof");
    if (submitButton.disabled) return;

    submitButton.disabled = true;
    submitButton.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ${translations[currentLang]['Submitting...'] || 'Submitting...'}`;
    const qrPaymentResultDiv = document.getElementById("qr-payment-result");
    qrPaymentResultDiv.textContent = '';

    try {
        const name = paymentNameInput.value.trim();
        const email = paymentEmailInput.value.trim();
        const phoneNumber = paymentPhoneInput.value.trim();
        const file = paymentFileInput.files[0];
        const qrManualPaymentPage = document.getElementById('qr-manual-payment-page');
        const paymentMethod = qrManualPaymentPage.getAttribute("data-payment-method");
        const cvTemplateCategory = qrManualPaymentPage.getAttribute("data-cv-template-category");
        const pricePaid = qrManualPaymentPage.getAttribute("data-price-paid");
        const actualDiscountCodeStr = qrManualPaymentPage.getAttribute("data-discount-code") || 'N/A';
        
        if (!name || !email) { // يكفي الاسم والإيميل كحد أدنى
            throw new Error(translations[currentLang]['Please fill in all fields.'] || 'Please fill in all required fields.');
        }
        if (!validateEmail(email)) {
            throw new Error(translations[currentLang]['Please enter a valid email.'] || 'Please enter a valid email address.');
        }
        
        toggleLoadingOverlay(true, 'payment_processing');
        
        const fileBase64 = file ? await fileToBase64(file) : null;
        const pdfData = await generatePdfFromNode(true); 
        
        if (!pdfData || !pdfData.base64Pdf) {
            throw new Error('Failed to generate CV PDF for submission.');
        }
        
        const formData = new URLSearchParams();
        formData.append('name', name);
        formData.append('email', email);
        formData.append('phoneNumber', phoneNumber);
        formData.append('pricePaid', pricePaid);
        formData.append('paymentMethod', paymentMethod);
        formData.append('cvTemplateCategory', cvTemplateCategory);
        formData.append('discountCode', actualDiscountCodeStr);
        formData.append('language', currentLang);
        formData.append('website', document.getElementById('website-input')?.value.trim() || '');
        formData.append('paymentFileBase64', fileBase64 || '');
        formData.append('paymentFileType', file?.type || '');
        formData.append('cvPdfFileBase64', pdfData.base64Pdf);
        formData.append('cvPdfFileName', `CV_Preview_${name.replace(/\s/g, '_')}.pdf`);

        // ▼▼▼ الجزء الجديد والمهم لرفع جودة المطابقة ▼▼▼
        formData.append('userAgent', navigator.userAgent); // 1. إرسال معلومات المتصفح
        const fbp = getCookie('_fbp'); // 2. قراءة كوكي المتصفح
        if (fbp) formData.append('fbp', fbp);
        const fbc = getCookie('_fbc'); // 3. قراءة كوكي النقرة (إن وجد)
        if (fbc) formData.append('fbc', fbc);
        // ▲▲▲ نهاية الجزء الجديد ▲▲▲

        const response = await fetch(GOOGLE_APPS_SCRIPT_WEB_APP_URL_PAYMENT_PROCESSOR, {
            method: 'POST',
            body: formData,
        });
        const data = await response.json();

        if (data.status === 'success') {
            localStorage.removeItem('resailCvData_' + currentLang);
            showPage('thank-you-page');
        } else {
            throw new Error(data.error || 'An unknown error occurred on the server.');
        }
    } catch (err) {
        console.error("Error in submitPaymentProof:", err);
        qrPaymentResultDiv.style.color = "red";
        qrPaymentResultDiv.textContent = err.message;
    } finally {
        toggleLoadingOverlay(false);
        if (qrPaymentResultDiv.textContent) {
           submitButton.disabled = false;
           submitButton.innerHTML = translations[currentLang].submit || 'Submit';
        }
    }
}
function fileToBase64(file){return new Promise((resolve,reject)=>{const reader=new FileReader();reader.readAsDataURL(file);reader.onload=()=>resolve(reader.result.split(',')[1]);reader.onerror=error=>reject(error)})}
function validateEmail(email){const re=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;return re.test(String(email).toLowerCase())}
function getExperiencesData(){const experiences=[];document.querySelectorAll('#experience-input .experience-entry').forEach(entry=>{const title=entry.querySelector('.experience-title')?.value.trim();const company=entry.querySelector('.experience-company')?.value.trim();const duration=entry.querySelector('.experience-duration')?.value.trim();const description=entry.querySelector('.experience-description')?.value.trim();if(title||company||duration||description){experiences.push({title,company,duration,description})}});return experiences}
function getEducationsData(){const educations=[];document.querySelectorAll('#education-input .education-entry').forEach(entry=>{const degree=entry.querySelector('.education-degree')?.value.trim();const institution=entry.querySelector('.education-institution')?.value.trim();const duration=entry.querySelector('.education-duration')?.value.trim();if(degree||institution||duration){educations.push({degree,institution,duration})}});return educations}
function getSkillsData(){const skills=[];document.querySelectorAll('#skills-input .skill-entry').forEach(entry=>{const name=entry.querySelector('.skill-item-input').value.trim();const level=entry.querySelector('.skill-level-select').value;if(name){skills.push({name,level})}});return skills}
function getLanguagesData(){const languages=[];document.querySelectorAll('#languages-input .language-item-input').forEach(input=>{const lang=input.value.trim();if(lang){languages.push(lang)}});return languages}
function getReferencesData(){const references=[];document.querySelectorAll('#references-input .reference-entry').forEach(entry=>{const name=entry.querySelector('.reference-name')?.value.trim();const position=entry.querySelector('.reference-position')?.value.trim();const phone=entry.querySelector('.reference-phone')?.value.trim();const email=entry.querySelector('.reference-email')?.value.trim();if(name||position||phone||email){references.push({name,position,phone,email})}});return references}
function getCustomSectionsData(){const sections=[];document.querySelectorAll('#custom-sections-container .custom-section-wrapper').forEach(sectionWrapper=>{const sectionTitle=sectionWrapper.querySelector('.custom-section-title')?.value.trim();if(!sectionTitle)return;const subSections=[];sectionWrapper.querySelectorAll('.custom-subsection-entry').forEach(subSectionEntry=>{const subTitle=subSectionEntry.querySelector('.custom-subsection-title')?.value.trim();const description=subSectionEntry.querySelector('.custom-subsection-description')?.value.trim();if(subTitle||description){subSections.push({title:subTitle,description:description})}});if(subSections.length>0){sections.push({title:sectionTitle,subSections:subSections})}});return sections}
function getSelectedTemplateCss(){let cssRules=[];const stylesheets=document.styleSheets;const commonSelectors=['body','html','#cv-container','.cv-content','.cv-header','.cv-name','.cv-title','.cv-contact-info','.cv-contact-item','.cv-profile-pic','.cv-section','.cv-section-title','.cv-experience-item','.cv-education-item','.cv-job-title','.cv-degree','.cv-company','.cv-institution','.cv-duration','.cv-skill-list','.cv-skill-item','.cv-language-list','.cv-reference-item','.cv-table-row','.cv-two-column-layout','.cv-professional-layout','.ast-layout','.cv-sidebar','.cv-main-content','.cv-end-marker','.filler','h1','h2','h3','h4','h5','p','ul','li','img','a','div','span','.container','.row','.col-md-','.d-flex','.mb-','.mt-','.ms-','.me-','.rtl','.ltr','.remove-field',];const commonSelectorsRegex=new RegExp(`(^|\\b)(<span class="math-inline">\{commonSelectors\.map\(s \=\> s\.replace\('\.', '\\\\\.'\)\)\.join\('\|'\)\}\)\(\\\\b\|</span>)`);for(let i=0;i<stylesheets.length;i++){try{const rules=stylesheets[i].cssRules||stylesheets[i].rules;if(!rules)continue;for(let j=0;j<rules.length;j++){const rule=rules[j];let ruleText=rule.cssText;if(rule.type===CSSRule.FONT_FACE_RULE){cssRules.push(ruleText);continue}
if(rule.type===CSSRule.MEDIA_RULE){if(rule.conditionText.includes('print')||rule.conditionText.includes('screen')||rule.conditionText.includes('(max-width:')){cssRules.push(ruleText)}
continue}
const selectorText=rule.selectorText;if(selectorText){const templateSpecificSelector=`.<span class="math-inline">\{selectedTemplateCategory\}\-layout\.template</span>{selectedTemplate}`;const isGeneral=commonSelectorsRegex.test(selectorText);const isTemplateSpecific=selectorText.includes(templateSpecificSelector);const isCvRelated=selectorText.includes('.cv-');const isFrontendUI=selectorText.includes('.navbar')||selectorText.includes('.site-header')||selectorText.includes('.page-section:not')||selectorText.includes('.progress-container')||selectorText.includes('.language-toggle');if((isGeneral||isTemplateSpecific||isCvRelated)&&!isFrontendUI){cssRules.push(ruleText)}}}}catch(e){console.warn(`Could not read CSS rules from stylesheet (possibly CORS issue): ${e.message}`)}}
cssRules.push(`
        /* 1. قواعد أساسية لـ HTML/BODY لتأكيد اتجاه الصفحة والهوامش */
        html, body {
            margin: 0 !important;
            padding: 0 !important;
            width: 210mm !important; /* عرض A4 */
            min-height: 297mm !important; /* ارتفاع A4 */
            background: white !important; /* خلفية بيضاء لضمان عدم ظهور خلفية العارض */
            color: #212529 !important; /* لون نص افتراضي */
            direction: ${currentLang === 'ar' ? 'rtl' : 'ltr'} !important;
            text-align: ${currentLang === 'ar' ? 'right' : 'left'} !important;
            box-sizing: border-box !important;
            overflow: hidden !important; /* مهم جداً لمنع أي scrollbars في الـ PDF */
        }
        body.rtl { direction: rtl !important; text-align: right !important; }
        body.ltr { direction: ltr !important; text-align: left !important; }

        /* 2. إخفاء جميع عناصر الواجهة الأمامية غير المرغوبة (بشكل شامل) */
        /* هذه المحددات يجب أن تستهدف عناصر واجهة المستخدم التي قد تظهر في الـ PDF */
        .site-header, .navbar, .page-section:not(.active-page), .progress-container,
        .language-toggle, .btn-info, .btn-success, #cv-preview-area,
        .popup-box, .popup-close, .form-group, .remove-field,
        .template-preview-container, .template-category, .template-previews,
        /* أي عناصر أخرى من واجهة المستخدم لديك في الـ HTML لا تريد ظهورها */
        .d-flex.justify-content-center.mt-4 { /* الأزرار في صفحة المعاينة */
            display: none !important;
            visibility: hidden !important;
            height: 0 !important;
            max-height: 0 !important;
            overflow: hidden !important;
            padding: 0 !important;
            margin: 0 !important;
        }

        /* 3. تأكيد تنسيق الـ CV للحاوية الرئيسية */
        #cv-container {
            position: relative !important;
            width: 210mm !important; /* عرض A4 */
            min-height: 297mm !important; /* ارتفاع A4 */
            height: auto !important; /* لتسمح بالنمو على عدة صفحات */
            margin: 0 !important; /* لإزالة أي إزاحة غير مرغوبة */
            padding: 0 !important; /* الحشوة تكون داخل الأقسام */
            box-shadow: none !important; /* إزالة أي ظل لحاوية المعاينة */
            border: none !important; /* إزالة أي حدود لحاوية المعاينة */
            background: white !important; /* خلفية بيضاء للسيرة الذاتية */
            color: #212529 !important; /* لون نص افتراضي */
            overflow: visible !important; /* مهم جداً للسماح بالمحتوى على عدة صفحات */
            direction: ${currentLang === 'ar' ? 'rtl' : 'ltr'} !important;
            text-align: ${currentLang === 'ar' ? 'right' : 'left'} !important;
            box-sizing: border-box !important;
        }

        /* 4. معالجة الخطوط (ضمان تطبيق Tajawal للعربية) */
        body, p, span, div, h1, h2, h3, h4, h5, h6, li {
            font-family: 'Tajawal', sans-serif !important;
        }
        /* قواعد الخطوط الخاصة بكل قالب (أضفها هنا أيضاً لتطغى) */
        .normal-layout.template1 .cv-name, .normal-layout.template1 .cv-title, .normal-layout.template1 .cv-section-title { font-family: 'Roboto', sans-serif !important; }
        .normal-layout.template2 .cv-name, .normal-layout.template2 .cv-title, .normal-layout.template2 .cv-section-title { font-family: 'Lato', sans-serif !important; }
        /* ... كرر هذا لجميع القوالب والفئات التي تحدد الخطوط في style.css */

        /* 5. معالجة تخطيط الأعمدة (Standard, Professional, AST) */
        .cv-two-column-layout, .ast-layout {
            display: flex !important; /* Use flex for print */
            flex-direction: var(--print-flex-direction) !important; /* Apply correct flex direction from variable */
            gap: 10mm !important;
            page-break-inside: auto !important; /* Allow page breaks here */
            flex-wrap: nowrap !important; /* Prevent wrapping to next line */
        }
        .cv-professional-layout {
            display: grid !important;
            grid-template-columns: var(--print-grid-columns) !important; /* Apply grid columns from variable */
            grid-template-areas: var(--print-grid-areas) !important; /* Apply grid areas from variable */
            gap: 10mm !important;
            page-break-inside: auto !important; /* Allow page breaks here */
        }
        .cv-sidebar, .cv-main-content {
            display: flex !important; /* Revert to flex for individual columns */
            flex-direction: column !important; /* Ensure content stacks vertically within column */
            vertical-align: top !important; /* Align to top */
            padding: 8mm !important; /* Inner padding */
            box-sizing: border-box !important;
            height: auto !important; /* Allow height to adjust */
            min-height: 1px !important; /* Smallest possible height */
            page-break-inside: avoid !important; /* Crucial: prevent breaking content within individual columns */
            text-align: ${currentLang === 'ar' ? 'right' : 'left'} !important; /* Text alignment within the column */
        }

        /* 5.1. تحديد عرض الأعمدة (إذا لم يكن في القالب الأصلي) */
        .cv-two-column-layout .cv-sidebar, .ast-layout .cv-sidebar { width: 80mm !important; flex-shrink: 0 !important; } /* Make sidebar fixed width */
        .cv-professional-layout .cv-sidebar { width: 80mm !important; flex-shrink: 0 !important; }
        .cv-main-content { width: auto !important; flex-grow: 1 !important;} /* Main content takes remaining space */


        /* 5.2. معالجة Professional Layout (حسب التغييرات في style.css الخاص بك) */
        /* ملف style.css الخاص بك يحتوي على Professional Layout يجعل الشريط الجانبي على اليسار دائماً */
        /* سنحافظ على هذا السلوك عند الطباعة */
        .cv-professional-layout[dir="rtl"], .cv-professional-layout[dir="ltr"] {
            /* These will be overridden by --print-grid-columns and --print-grid-areas */
            /* grid-template-columns: 80mm 1fr !important; */
            /* grid-template-areas: "sidebar main" !important; */
        }
        .cv-professional-layout .cv-sidebar { grid-area: sidebar !important; }
        .cv-professional-layout .cv-main-content { grid-area: main !important; }
        .cv-professional-layout .cv-header.professional-layout { grid-area: header !important; display: flex !important; flex-direction: column !important; } /* Use flex for header content within grid */


        /* 6. تحسينات عامة على العناصر النصية والقوائم */
        h1, h2, h3, h4, h5, h6, p, li {
            word-break: break-word !important;
            white-space: pre-wrap !important; /* للحفاظ على الأسطر الجديدة من textarea */
            line-height: 1.6 !important;
            margin: 0 !important; /* لإزالة أي هوامش افتراضية غير مرغوبة */
            padding: 0 !important;
        }
        ul {
            list-style: none !important;
            padding: 0 !important;
            margin: 0 !important;
            text-align: ${currentLang === 'ar' ? 'right' : 'left'} !important;
        }
        /* إذا كنت تستخدم نقاطاً للقوائم، يمكنك إعادتها يدوياً لـ RTL/LTR */
        html[dir="rtl"] ul li::before {
            content: "• " !important; /* نقطة القائمة */
            color: inherit !important;
            display: inline-block !important;
            width: 1em !important;
            margin-left: 0.5em !important;
            text-align: left !important;
        }
        html[dir="ltr"] ul li::before {
            content: "• " !important;
            color: inherit !important;
            display: inline-block !important;
            width: 1em !important;
            margin-right: 0.5em !important;
            text-align: right !important;
        }
        .cv-skill-item, .cv-language-list li {
            text-align: inherit !important;
            padding-right: ${currentLang === 'ar' ? '0' : '15px'} !important;
            padding-left: ${currentLang === 'ar' ? '15px' : '0'} !important;
        }
        .cv-contact-item i {
            margin-left: ${currentLang === 'ar' ? '8px' : '0'} !important;
            margin-right: ${currentLang === 'ar' ? '0' : '8px'} !important;
        }

        /* 7. قواعد للطباعة / التوليد التي يجب أن تطغى في سياق الطباعة (مكررة لكن مهمة) */
        @media print {
            html, body {
                margin: 0 !important; padding: 0 !important;
                width: 210mm !important;
                min-height: 297mm !important;
                background: white !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                direction: ${currentLang === 'ar' ? 'rtl' : 'ltr'} !important;
                text-align: ${currentLang === 'ar' ? 'right' : 'left'} !important;
            }
            #cv-container {
                box-shadow: none !important;
                border: none !important;
                min-height: 297mm !important;
                height: auto !important;
                overflow: visible !important;
                page-break-before: auto !important;
                page-break-after: auto !important;
                page-break-inside: auto !important; /* Allow page breaks inside container */
                margin: 0 !important;
                padding: 0 !important;
            }
            .cv-section { page-break-inside: avoid !important; }
            .cv-experience-item, .cv-education-item, .cv-reference-item { page-break-inside: avoid !important; }
        }
    `);return cssRules.join('\n')}
async function generatePdfFromNode(isPaid){toggleLoadingOverlay(!0,'pdf_generation_in_progress');try{const cvPreviewElement=document.getElementById('cv-container');if(!cvPreviewElement)throw new Error("CV container not found.");const fetchCss=async(url)=>{const response=await fetch(url);if(!response.ok)throw new Error(`Failed to fetch ${url}`);return response.text()};const[mainCss,templatesCss,responsiveCss]=await Promise.all([fetchCss('style.css'),fetchCss('templates.css'),fetchCss('responsive.css')]);const fullCssText=mainCss+templatesCss+responsiveCss;const tempContainer=document.createElement('div');generateCV(tempContainer);const finalHtml=tempContainer.innerHTML;tempContainer.remove();const cvData=collectCvData();const direction=cvData.language==='ar'?'rtl':'ltr';const colorVariablesCSS=getColorVariablesAsCssText();const dynamicStylesFromElement=cvPreviewElement.style.cssText;const dynamicStyleRule=`#cv-container { ${dynamicStylesFromElement} }`;const isArabic=currentLang==='ar';const nameFont=document.getElementById('font-selector-name')?.value||(isArabic?"'Cairo', sans-serif":"'Playfair Display', serif");const headingsFont=document.getElementById('font-selector-headings')?.value||(isArabic?"'Tajawal', sans-serif":"'Montserrat', sans-serif");const bodyFont=document.getElementById('font-selector-body')?.value||(isArabic?"'Almarai', sans-serif":"'Roboto', sans-serif");const printCssOverrides=`
            body { padding-top: 0 !important; }
            ${colorVariablesCSS}
            ${dynamicStyleRule}
            #cv-container { font-family: ${bodyFont} !important; }
            #cv-container .cv-name, #cv-container .cv-title { font-family: ${nameFont} !important; }
            #cv-container .cv-section-title { font-family: ${headingsFont} !important; }
        `;const fullPageHtml=`
            <!DOCTYPE html>
            <html lang="${cvData.language}" dir="${direction}">
            <head>
                <meta charset="UTF-8">
                <title>CV</title>
                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
                <link rel="preconnect" href="https://fonts.googleapis.com">
                <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
                <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@400;700&family=Cairo:wght@400;700&family=Tajawal:wght@400;700&family=Amiri:wght@400;700&family=Lalezar&family=Markazi+Text:wght@400;700&family=Roboto:wght@400;700&family=Lato:wght@400;700&family=Montserrat:wght@400;700&family=Open+Sans:wght@400;700&family=PT+Sans:wght@400;700&family=Playfair+Display:wght@400;700&family=Noto+Serif:wght@400;700&display=swap" rel="stylesheet">
                <style>
                    ${fullCssText}
                    ${printCssOverrides}
                </style>
            </head>
            <body class="${direction}">
                 <div id="cv-container" class="${isPaid ? '' : 'watermarked'} ${cvData.templateCategory}-layout template${cvData.templateNumber}" dir="${direction}">
                    ${finalHtml}
                 </div>
            </body>
            </html>
        `;
        const requestBody = {
            fullHtml: fullPageHtml,
            isWatermarked: !isPaid, // إذا لم تكن مدفوعة، فهي بعلامة مائية
            // أرسل بيانات المستخدم فقط إذا كانت عينة (غير مدفوعة)
            userData: !isPaid ? {
                email: cvData.email,
                name: cvData.name,
                lang: cvData.language
            } : null
        };
const response=await fetch(`${NODE_SERVER_URL}/generate-cv`,{method:'POST',headers:{'Content-Type':'application/json'},body: JSON.stringify(requestBody),mode:'cors'});if(!response.ok)throw new Error(await response.text());const pdfData=await response.json();if(pdfData&&pdfData.status==='success'){return pdfData}else{throw new Error(pdfData.message||"Failed to generate PDF on server.")}}catch(error){console.error("Error in generatePdfFromNode:",error);alert('An error occurred while preparing the PDF: '+error.message);return null}finally{toggleLoadingOverlay(!1)}}
async function sendFinalHtmlToServer(finalHtml,isPaid){const mainCssText=document.getElementById('main-stylesheet')?.textContent||'';if(!mainCssText){throw new Error("Critical: Main stylesheet could not be found in the DOM.")}
const cvData=collectCvData();const direction=cvData.language==='ar'?'rtl':'ltr';const fullPageHtml=`
        <!DOCTYPE html>
        <html lang="${cvData.language}" dir="${direction}">
        <head>
            <meta charset="UTF-8">
            <title>CV</title>
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
            <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
            <style>
                ${mainCssText}
            </style>
        </head>
        <body class="${direction}">
             ${finalHtml.replace('class="', `class="${isPaid ? '' : 'watermarked'} `)}
        </body>
        </html>
    `;

    const response = await fetch(`${NODE_SERVER_URL}/generate-cv`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ fullHtml: fullPageHtml }),
        mode: 'cors'
    });

    if (!response.ok) {
        const errorBody = await response.json().catch(() => ({ message: 'Server error' }));
        throw new Error(`Node.js server error: ${response.status} - ${errorBody.message}`);
    }

    return await response.json();
}
/**
 * دالة مركزية لإرسال بيانات الدفع والـ PDF النهائي إلى Google Apps Script.
 * هذه الدالة لا تقوم بتوليد الـ PDF بنفسها، بل تستقبله كبيانات جاهزة.
 * @param {string} paymentMethod - طريقة الدفع (مثال: 'PayPal', 'STC Pay', 'Discounted/Free').
 * @param {number} pricePaid - المبلغ المدفوع.
 * @param {string} cvPdfBase64 - بيانات السيرة الذاتية بصيغة Base64 (تم توليدها مسبقاً).
 * @param {File|null} paymentFile - ملف الإيصال (للدفع اليدوي)، أو null للعمليات التلقائية.
 */
async function sendPaymentDataToAppsScript(paymentMethod, pricePaid, cvPdfBase64, paymentFile) {
    toggleLoadingOverlay(true, 'please_wait_and_do_not_refresh');
    try {
        // ... (كل الكود الحالي لجمع البيانات وتجهيز formData يبقى كما هو)
        const name = document.getElementById('name-input')?.value.trim() || 'Unnamed User';
        const email = document.getElementById('email-input')?.value.trim();
        const phoneNumber = document.getElementById('phone-input')?.value.trim();
        const website = document.getElementById('website-input')?.value.trim();
        
        const formData = new URLSearchParams();
        formData.append('name', name);
        formData.append('email', email);
        formData.append('phoneNumber', phoneNumber || '');
        formData.append('website', website || '');
        formData.append('pricePaid', pricePaid.toString());
        formData.append('paymentMethod', paymentMethod);
        formData.append('cvTemplateCategory', selectedTemplateCategory);
        formData.append('discountCode', appliedCode || (pricePaid === 0 ? 'FREECV' : 'N/A')); // Ensure FREECV is sent
        formData.append('language', currentLang);
        formData.append('cvPdfFileBase64', cvPdfBase64);
        formData.append('cvPdfFileName', `CV_${name.replace(/\s/g, '_')}.pdf`);
        
        const response = await fetch(GOOGLE_APPS_SCRIPT_WEB_APP_URL_PAYMENT_PROCESSOR, {
            method: 'POST',
            body: formData,
        });
        const data = await response.json();

        if (data.status === 'success') {
            return true; // إرجاع "نجاح"
        } else {
            throw new Error(data.error || 'An unknown error occurred.');
        }
    } catch (err) {
        console.error("Error in sendPaymentDataToAppsScript:", err);
        alert((translations[currentLang]["Error processing file."] || "Error:") + " " + err.message);
        return false; // إرجاع "فشل"
    } finally {
        toggleLoadingOverlay(false);
    }
}

// دالة مساعدة لتحويل Base64 إلى Blob
function base64toBlob(base64, type = 'application/octet-stream') {
    const binStr = atob(base64);
    const len = binStr.length;
    const arr = new Uint8Array(len);
    for (let i = 0; i < len; i++) {
        arr[i] = binStr.charCodeAt(i);
    }
    return new Blob([arr], { type: type });
}


function selectTemplate(clickedElement, templateNumber, category) {
    const cvContainer = document.getElementById('cv-container');
    
    document.querySelectorAll('.template-preview').forEach(p => p.classList.remove('selected-template'));
    if (clickedElement) {
        clickedElement.classList.add('selected-template');
    }

    cvContainer.className = ''; 
    cvContainer.classList.add(`${category}-layout`, `template${templateNumber}`);
    
    selectedTemplate = templateNumber;
    selectedTemplateCategory = category;

    // --- منطق إظهار وإخفاء بطاقة الخصم المجاني ---
    const freeCvCard = document.getElementById('free-cv-card');
    if (freeCvCard) {
        if (category === 'normal' || category === 'standard') {
            freeCvCard.style.display = 'flex';
        } else {
            freeCvCard.style.display = 'none';
        }
    }
    
    updateControlsForCategory();
    createPaletteControls();
    generateCV(cvContainer);
    updateColorControlVisibility(); 
}


/**
 * يعالج تغيير الصورة الشخصية، ويعرض معاينة كأيقونة، ويقوم بتصغير الصورة.
 */
function handleProfilePicChange(event) {
    const file = event.target.files[0];
    const inputElement = event.target;
    
    // العثور على عناصر الواجهة: اسم الملف وأيقونة المعاينة
    const fileNameDisplay = document.getElementById('file-name-display');
    const picPreview = document.getElementById('profile-pic-preview'); // ⭐ البحث عن عنصر المعاينة

    if (!file) {
        profilePicDataUrl = null;
        if(fileNameDisplay) fileNameDisplay.textContent = '';
        if(picPreview) picPreview.style.display = 'none'; // ⭐ إخفاء المعاينة عند الإلغاء
        generateCV(cvContainer);
        updateProgress();
        return;
    }

    if(fileNameDisplay) fileNameDisplay.textContent = file.name;

    // التحقق من نوع وحجم الملف
    if (!file.type.startsWith('image/')) {
        alert(translations[currentLang]['Please select a valid image file.']);
        inputElement.value = '';
        if(fileNameDisplay) fileNameDisplay.textContent = '';
        if(picPreview) picPreview.style.display = 'none'; // ⭐ إخفاء المعاينة عند الخطأ
        return;
    }
    if (file.size > MAX_FILE_SIZE) {
        alert(translations[currentLang]['Image size is too large. Please select an image smaller than {size} megabytes.'].replace('{size}', MAX_FILE_SIZE / 1024 / 1024));
        inputElement.value = '';
        if(fileNameDisplay) fileNameDisplay.textContent = '';
        if(picPreview) picPreview.style.display = 'none'; // ⭐ إخفاء المعاينة عند الخطأ
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        // ⭐ عرض الصورة المختارة فورًا في أيقونة المعاينة
        if (picPreview) {
            picPreview.src = e.target.result;
            picPreview.style.display = 'inline-block'; // إظهار الأيقونة
        }

        const img = new Image();
        img.onload = function() {
            const canvas = document.createElement('canvas');
            const MAX_WIDTH = 400;
            const MAX_HEIGHT = 400;
            let width = img.width;
            let height = img.height;

            if (width > height) {
                if (width > MAX_WIDTH) {
                    height *= MAX_WIDTH / width;
                    width = MAX_WIDTH;
                }
            } else {
                if (height > MAX_HEIGHT) {
                    width *= MAX_HEIGHT / height;
                    height = MAX_HEIGHT;
                }
            }
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            profilePicDataUrl = canvas.toDataURL('image/jpeg', 0.9);

            generateCV(cvContainer);
            updateProgress();
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

function addExperienceField(data = null) {
    const container = document.getElementById('experience-input');
    if (!container) return;
    const newEntry = document.createElement('div');
    newEntry.className = 'experience-entry';
    newEntry.innerHTML = `
        <button type="button" class="remove-field" onclick="removeField(this)"><i class="fas fa-times-circle"></i></button>
        <input type="text" placeholder="${translations[currentLang]['Job Title_placeholder']||'Job Title'}" class="experience-title" oninput="generateCV(cvContainer);updateProgress()">
        <input type="text" placeholder="${translations[currentLang].Company||'Company'}" class="experience-company" oninput="generateCV(cvContainer);updateProgress()">
        <input type="text" placeholder="${translations[currentLang].Duration||'Duration'}" class="experience-duration" oninput="generateCV(cvContainer);updateProgress()">
        <textarea placeholder="${translations[currentLang].Description||'Description'}" class="experience-description" oninput="generateCV(cvContainer);updateProgress()"></textarea>
    `;
    container.appendChild(newEntry);

    if (data) {
        newEntry.querySelector('.experience-title').value = data.title || '';
        newEntry.querySelector('.experience-company').value = data.company || '';
        newEntry.querySelector('.experience-duration').value = data.duration || '';
        
        // ▼▼▼ الجزء الذي تم تعديله ▼▼▼
        // التحقق مما إذا كان الوصف عبارة عن قائمة (array)
        if (Array.isArray(data.description)) {
            // إذا كان كذلك، قم بدمج عناصر القائمة مع وضع سطر جديد بين كل عنصر
            newEntry.querySelector('.experience-description').value = data.description.join('\n');
        } else {
            // وإلا، ضعه كما هو
            newEntry.querySelector('.experience-description').value = data.description || '';
        }
        // ▲▲▲ نهاية الجزء المعدل ▲▲▲
    }
}
function removeLastExperienceField() {
    const experienceInput = document.getElementById('experience-input');
    if (!experienceInput) return;
    const entries = experienceInput.querySelectorAll('.experience-entry');
    if (entries.length > 1) {
        experienceInput.removeChild(entries[entries.length - 1]);
        generateCV(cvContainer); updateProgress();
    } else {
        alert(translations[currentLang]['You must have at least one field in this section.']);
    }
}

function addEducationField(data = null) {
    const educationInput = document.getElementById('education-input');
    if (!educationInput) return;
    const newEntry = document.createElement('div');
    newEntry.className = 'education-entry';
    // --- ⭐ تعديل: استخدام كائن الترجمة مباشرة ---
    newEntry.innerHTML = `
         <button type="button" class="remove-field" onclick="removeField(this)"><i class="fas fa-times-circle"></i></button>
        <input type="text" placeholder="${translations[currentLang].Degree||'Degree'}" class="education-degree" oninput="generateCV(cvContainer);updateProgress()">
        <input type="text" placeholder="${translations[currentLang]['University/Institution']||'University/Institution'}" class="education-institution" oninput="generateCV(cvContainer);updateProgress()">
        <input type="text" placeholder="${translations[currentLang].Duration||'Duration'}" class="education-duration" oninput="generateCV(cvContainer);updateProgress()">
    `;
    educationInput.appendChild(newEntry);

    if (data) {
        newEntry.querySelector('.education-degree').value = data.degree || '';
        newEntry.querySelector('.education-institution').value = data.institution || '';
        newEntry.querySelector('.education-duration').value = data.duration || '';
    }
}

// استبدل دالة addSkillField بالكامل
function addSkillField(data = null) {
    const skillsInput = document.getElementById('skills-input');
    if (!skillsInput) return;

    // --- إنشاء العناصر برمجياً (الطريقة الجديدة) ---
    const newEntry = document.createElement('div');
    newEntry.className = 'skill-entry border p-2 mb-2 rounded position-relative';

    const removeButton = document.createElement('button');
    removeButton.type = 'button';
    removeButton.className = 'remove-field';
    removeButton.innerHTML = '&times;';
    removeButton.onclick = () => removeField(removeButton);

    const row = document.createElement('div');
    row.className = 'row';

    const col1 = document.createElement('div');
    col1.className = 'col-md-6';
    const nameInput = document.createElement('input');
    nameInput.type = 'text';
    nameInput.className = 'form-control skill-item-input';
    nameInput.placeholder = translations[currentLang]['Enter a skill'] || 'Enter a skill';
    nameInput.oninput = () => { generateCV(cvContainer); updateProgress(); };
    col1.appendChild(nameInput);

    const col2 = document.createElement('div');
    col2.className = 'col-md-6';
    const levelSelect = document.createElement('select');
    levelSelect.className = 'form-select skill-level-select';
    levelSelect.onchange = () => { generateCV(cvContainer); updateProgress(); };
    
    // إضافة خيارات القائمة المنسدلة مع الترجمة
    const levels = {
        '0': 'Select Level',
        '30%': 'Beginner',
        '50%': 'Intermediate',
        '75%': 'Advanced',
        '100%': 'Expert'
    };
    for (const [value, key] of Object.entries(levels)) {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = translations[currentLang][key] || key;
        levelSelect.appendChild(option);
    }
    col2.appendChild(levelSelect);

    row.appendChild(col1);
    row.appendChild(col2);
    newEntry.appendChild(removeButton);
    newEntry.appendChild(row);
    skillsInput.appendChild(newEntry);

    // ملء البيانات إذا كانت موجودة (للاسترجاع من الذاكرة)
    if (data) {
        nameInput.value = data.name || (typeof data === 'string' ? data : '');
        if (data.level) levelSelect.value = data.level;
    }
}
// ولا تنس تعديل دالة جلب بيانات المهارات لتقرأ المستوى أيضاً
function getSkillsData() {
    const skills = [];
    document.querySelectorAll('#skills-input .skill-entry').forEach(entry => {
        const name = entry.querySelector('.skill-item-input').value.trim();
        const level = entry.querySelector('.skill-level-select').value;
        if (name && level !== '0') {
            skills.push({ name, level });
        }
    });
    return skills;
}

// وأضف الترجمات الجديدة لكائن translations
// في قسم ar
// "Select Level": "اختر المستوى", "Beginner": "مبتدئ", "Intermediate": "متوسط", "Advanced": "متقدم", "Expert": "خبير"
// في قسم en
// "Select Level": "Select Level", "Beginner": "Beginner", "Intermediate": "Intermediate", "Advanced": "Advanced", "Expert": "Expert"

function removeLastSkillField() {
    const skillsInput = document.getElementById('skills-input');
    if (!skillsInput) return;
    const entries = skillsInput.querySelectorAll('.skill-entry');
    // تعديل: نحذف طالما يوجد عنصر واحد على الأقل
    if (entries.length > 0) {
        skillsInput.removeChild(entries[entries.length - 1]);
        generateCV(cvContainer); 
        updateProgress();
    }
}

function removeLastLanguageField() {
    const languagesInput = document.getElementById('languages-input');
    if (!languagesInput) return;
    const entries = languagesInput.querySelectorAll('.language-entry');
    // تعديل: نحذف طالما يوجد عنصر واحد على الأقل
    if (entries.length > 0) {
        languagesInput.removeChild(entries[entries.length - 1]);
        generateCV(cvContainer); 
        updateProgress();
    }
}

function removeLastReferenceField() {
    const referencesInput = document.getElementById('references-input');
    if (!referencesInput) return;
    const entries = referencesInput.querySelectorAll('.reference-entry');
    // تعديل: نحذف طالما يوجد عنصر واحد على الأقل
    if (entries.length > 0) {
        referencesInput.removeChild(entries[entries.length - 1]);
        generateCV(cvContainer); 
        updateProgress();
    }
}

function removeField(button) {
    const entry = button.parentElement;
    const parentContainer = entry.parentElement;
    // تعديل: أزلنا الشرط الذي يمنع حذف آخر عنصر
    parentContainer.removeChild(entry);
    generateCV(cvContainer); 
    updateProgress();
}

function addLanguageField(data = null) {
    const languagesInput = document.getElementById('languages-input');
    if (!languagesInput) return;
    const newEntry = document.createElement('div');
    newEntry.className = 'language-entry';
    // --- ⭐ تعديل: استخدام كائن الترجمة مباشرة ---
    newEntry.innerHTML = `
        <button type="button" class="remove-field" onclick="removeField(this)"><i class="fas fa-times-circle"></i></button>
        <input type="text" placeholder="${translations[currentLang]['Enter a language']||'Enter a language'}" class="language-item-input" oninput="generateCV(cvContainer);updateProgress()">
    `;
    languagesInput.appendChild(newEntry);
    
    if (data) {
        newEntry.querySelector('.language-item-input').value = data || '';
    }
}

function addReferenceField(data = null) {
    const referencesInput = document.getElementById('references-input');
    if (!referencesInput) return;
    const newEntry = document.createElement('div');
    newEntry.className = 'reference-entry';
    // --- ⭐ تعديل: استخدام كائن الترجمة مباشرة ---
    newEntry.innerHTML = `
        <button type="button" class="remove-field" onclick="removeField(this)"><i class="fas fa-times-circle"></i></button>
        <input type="text" placeholder="${translations[currentLang].Name||'Name'}" class="reference-name" oninput="generateCV(cvContainer);updateProgress()">
        <input type="text" placeholder="${translations[currentLang].Position||'Position'}" class="reference-position" oninput="generateCV(cvContainer);updateProgress()">
        <input type="text" placeholder="${translations[currentLang].Phone||'Phone'}" class="reference-phone" oninput="generateCV(cvContainer);updateProgress()">
        <input type="email" placeholder="${translations[currentLang].Email||'Email'}" class="reference-email" oninput="generateCV(cvContainer);updateProgress()">
    `;
    referencesInput.appendChild(newEntry);

    if (data) {
        newEntry.querySelector('.reference-name').value = data.name || '';
        newEntry.querySelector('.reference-position').value = data.position || '';
        newEntry.querySelector('.reference-phone').value = data.phone || '';
        newEntry.querySelector('.reference-email').value = data.email || '';
    }
}



/**
 * =========================================================================
 * == دالة generateCV النهائية - مع إضافة عنصر التمدد (endmarker) ==
 * =========================================================================
 * @param {HTMLElement} targetElement The DOM element to populate with CV content.
 */
function generateCV(targetElement) {
    if (!targetElement) {
        console.error("[generateCV]Target element is null!");
        return;
    }

    const isArabic = currentLang === 'ar';
    const direction = isArabic ? 'rtl' : 'ltr';
    targetElement.dir = direction;
    targetElement.innerHTML = ''; // مسح المحتوى القديم

    // --- 1. جمع البيانات ---
    const name = document.getElementById('name-input')?.value.trim() || '';
    const title = document.getElementById('title-input')?.value.trim() || '';
    const emailVal = document.getElementById('email-input')?.value.trim() || '';
    const phone = document.getElementById('phone-input')?.value.trim() || '';
    const website = document.getElementById('website-input')?.value.trim() || '';
    const objective = document.getElementById('objective-input')?.value.trim() || '';

    // --- 2. بناء أجزاء HTML ---
    const endMarkerHTML = createEndMarkerHTML();
    let profilePicHTML = profilePicDataUrl ? `<img src="${profilePicDataUrl}" class="cv-profile-pic" alt="Profile Picture">` : '';

    let contactInfoHTML = `<div class="cv-section" data-section-name="contact-info"><div class="cv-contact-info">`;
    if (emailVal) contactInfoHTML += `<div class="cv-contact-item"><i class="fas fa-envelope"></i><p>${emailVal}</p></div>`;
    if (phone) contactInfoHTML += `<div class="cv-contact-item"><i class="fas fa-phone"></i><p>${phone}</p></div>`;
    if (website) contactInfoHTML += `<div class="cv-contact-item"><i class="fas fa-map-marker-alt"></i><p>${website}</p></div>`;
    contactInfoHTML += '</div></div>';

    const objectiveHTML = objective ? `<div class="cv-section" id="objective"><h3 class="cv-section-title">${translations[currentLang]['Career Objective']}</h3><p>${objective.replace(/(\r\n|\n|\r)+/g, '<br>')}</p></div>` : '';

    let experienceHTML = '';
    const experienceEntries = getExperiencesData();
    if (experienceEntries.length > 0 && experienceEntries.some(e => e.title || e.company)) {
        experienceHTML = `<div class="cv-section" id="experience"><h3 class="cv-section-title">${translations[currentLang]['Work Experience']}</h3>`;
        experienceEntries.forEach(entry => {
            if (entry.title || entry.company) {
                experienceHTML += `<div class="cv-experience-item"><h4 class="cv-job-title">${entry.title}</h4><h5 class="cv-company">${entry.company}${entry.company && entry.duration ? ' - ' : ''}${entry.duration}</h5><p>${entry.description.replace(/(\r\n|\n|\r)+/g, '<br>')}</p></div>`;
            }
        });
        experienceHTML += '</div>';
    }

    let educationHTML = '';
    const educationEntries = getEducationsData();
    if (educationEntries.length > 0 && educationEntries.some(e => e.degree || e.institution)) {
        educationHTML = `<div class="cv-section" id="education"><h3 class="cv-section-title">${translations[currentLang]['Education']}</h3>`;
        educationEntries.forEach(entry => {
             if (entry.degree || entry.institution) {
                educationHTML += `<div class="cv-education-item"><h4 class="cv-degree">${entry.degree}</h4><h5 class="cv-institution">${entry.institution}${entry.institution && entry.duration ? ' - ' : ''}${entry.duration}</h5></div>`;
            }
        });
        educationHTML += '</div>';
    }

    let customSectionsHTML = '';
    const customSections = getCustomSectionsData();
    if (customSections.length > 0) {
        customSections.forEach(section => {
            customSectionsHTML += `<div class="cv-section" id="custom-${section.title.replace(/\s+/g,'-')}">`;
            customSectionsHTML += `<h3 class="cv-section-title">${section.title}</h3>`;
            section.subSections.forEach(sub => {
                customSectionsHTML += `<div class="cv-experience-item">`; // نستخدم نفس تنسيق الخبرات
                if (sub.title) {
                    customSectionsHTML += `<h4 class="cv-job-title">${sub.title}</h4>`;
                }
                if (sub.description) {
                    customSectionsHTML += `<p>${sub.description.replace(/(\r\n|\n|\r)+/g, '<br>')}</p>`;
                }
                customSectionsHTML += `</div>`;
            });
            customSectionsHTML += `</div>`;
        });
    }
    
    const skillsContainerClass = (selectedTemplateCategory === 'normal') ? 'horizontal-skills' : 'vertical-skills';

    let skillsHTMLWithLevels = '';
    const skillsWithLevels = getSkillsData();
    if (skillsWithLevels.length > 0) {
        // 2. نستخدم المتغير الجديد لوضع الكلاس الصحيح في الـ HTML
        skillsHTMLWithLevels = `<div class="cv-section" id="skills"><h3 class="cv-section-title">${translations[currentLang]['Skills']}</h3><div class="skills-container ${skillsContainerClass}">`;
        skillsWithLevels.forEach(skill => {
            skillsHTMLWithLevels += `<div class="skill-item-wrapper"><span class="skill-name">${skill.name}</span><div class="skill-level-bar"><div class="skill-level-progress" style="width:${skill.level};"></div></div></div>`;
        });
        skillsHTMLWithLevels += '</div></div>';
    }

    
    let languagesHTML = '';
    const filledLanguages = getLanguagesData();
    if (filledLanguages.length > 0) {
        languagesHTML = `<div class="cv-section" id="languages"><h3 class="cv-section-title">${translations[currentLang]['Languages']}</h3><ul class="cv-language-list">`;
        filledLanguages.forEach(lang => { languagesHTML += `<li>${lang}</li>`; });
        languagesHTML += '</ul></div>';
    }
    
    let referencesHTML = '';
    const referenceEntries = getReferencesData();
    if (referenceEntries.length > 0 && referenceEntries.some(r => r.name)) {
        referencesHTML = `<div class="cv-section" id="references"><h3 class="cv-section-title">${translations[currentLang]['References']}</h3><div class="cv-references-list">`;
        referenceEntries.forEach(ref => {
            if(ref.name) {
                referencesHTML += `<div class="cv-reference-item"><h4>${ref.name}</h4><p>${ref.position || ''}</p><p>${ref.phone || ''}</p><p>${ref.email || ''}</p></div>`;
            }
        });
        referencesHTML += '</div></div>';
    }

    // --- 3. بناء الهيكل النهائي بناءً على فئة القالب ---
    const cvContentDiv = document.createElement('div');
    cvContentDiv.className = 'cv-content';

    if (selectedTemplateCategory === 'normal') {
        cvContentDiv.innerHTML = `<div class="cv-header">${profilePicHTML}<div class="cv-header-text"><h1 class="cv-name">${name}</h1><h2 class="cv-title">${title}</h2>${contactInfoHTML}</div></div><div class="cv-body-content">${objectiveHTML}${experienceHTML}${customSectionsHTML}${educationHTML}${skillsHTMLWithLevels}${languagesHTML}${referencesHTML}${endMarkerHTML}</div>`;
    } 
    else if (selectedTemplateCategory === 'creative') {
        if (selectedTemplate == 1) {
            cvContentDiv.innerHTML = `<div class="header-wave">${profilePicHTML}<div class="header-text"><h1 class="cv-name">${name}</h1><h2 class="cv-title">${title}</h2></div></div><div class="content-columns"><div class="left-column">${objectiveHTML}${experienceHTML}${customSectionsHTML}${educationHTML}${referencesHTML}${endMarkerHTML}</div><div class="right-column">${contactInfoHTML}${skillsHTMLWithLevels}${languagesHTML}${endMarkerHTML}</div></div>`;
        } else if (selectedTemplate == 2) {
              cvContentDiv.innerHTML = `<div class="header-wave"><div style="display: flex; flex-direction: column; align-items: center;"><h1 class="cv-name">${name}</h1><h2 class="cv-title">${title}</h2></div></div><div class="content-columns"><div class="left-column">${objectiveHTML}${experienceHTML}${customSectionsHTML}${educationHTML}${endMarkerHTML}</div><div class="right-column">${profilePicHTML}${contactInfoHTML}${skillsHTMLWithLevels}${languagesHTML}${referencesHTML}${endMarkerHTML}</div></div>`;
        } else if (selectedTemplate == 3) {
            cvContentDiv.innerHTML = `<div class="cv-sidebar"><div class="cv-header two-col-main">${profilePicHTML}<h1 class="cv-name">${name}</h1><h2 class="cv-title">${title}</h2></div>${contactInfoHTML}${skillsHTMLWithLevels}${languagesHTML}${referencesHTML}${endMarkerHTML}</div><div class="cv-main-content">${objectiveHTML}${experienceHTML}${customSectionsHTML}${educationHTML}${endMarkerHTML}</div>`;
        }
    }
    // === بداية: الكود المصحح الذي يعالج كل الفئات المتبقية ===
    else { // هذا الكود سيعالج الآن Standard, AST, و Professional بشكل صحيح
        const layoutDiv = document.createElement('div');
        const sidebarDiv = document.createElement('div');
        sidebarDiv.className = 'cv-sidebar';
        const mainContentDiv = document.createElement('div');
        mainContentDiv.className = 'cv-main-content';

        if (selectedTemplateCategory === 'professional') {
            layoutDiv.className = 'cv-professional-layout';
            const professionalHeader = document.createElement('div');
            professionalHeader.className = 'cv-header professional-layout';
    
            // --- المنطق الجديد لتوزيع المحتوى بشكل صحيح من البداية ---
            let headerHTML, sidebarHTML;
            
            // إذا كان القالب 1 أو 3
            if (selectedTemplate == 1 || selectedTemplate == 3) {
                // الصورة ومعلومات الاتصال تكون في الرأس
                const contactForHeader = contactInfoHTML.replace('<div class="cv-section" data-section-name="contact-info">', '').replace(/<\/div>$/, '');
                headerHTML = `<div class="cv-details">${profilePicHTML}<h1 class="cv-name">${name}</h1><h2 class="cv-title">${title}</h2>${contactForHeader}</div>`;
                sidebarHTML = `${skillsHTMLWithLevels}${languagesHTML}${referencesHTML}${endMarkerHTML}`;
            } 
            // إذا كان القالب 2
            else { 
                // الصورة ومعلومات الاتصال تكون في العامود الجانبي
                headerHTML = `<div class="cv-details"><h1 class="cv-name">${name}</h1><h2 class="cv-title">${title}</h2></div>`;
                sidebarHTML = `${profilePicHTML}${contactInfoHTML}${skillsHTMLWithLevels}${languagesHTML}${referencesHTML}${endMarkerHTML}`;
            }
    
            professionalHeader.innerHTML = headerHTML;
            sidebarDiv.innerHTML = sidebarHTML;
            mainContentDiv.innerHTML = `${objectiveHTML}${experienceHTML}${customSectionsHTML}${educationHTML}${endMarkerHTML}`;
            cvContentDiv.appendChild(professionalHeader);           

        } else { // هذا الجزء يعالج Standard و AST كما كان
            layoutDiv.className = 'cv-two-column-layout';
            sidebarDiv.innerHTML = profilePicHTML + contactInfoHTML + skillsHTMLWithLevels + languagesHTML + referencesHTML + endMarkerHTML;
            mainContentDiv.innerHTML = `<div class="cv-header two-col-main"><h1 class="cv-name">${name}</h1><h2 class="cv-title">${title}</h2></div>${objectiveHTML}${experienceHTML}${customSectionsHTML}${educationHTML}${endMarkerHTML}`;
        }
        
        layoutDiv.appendChild(sidebarDiv);
        layoutDiv.appendChild(mainContentDiv);
        cvContentDiv.appendChild(layoutDiv);
    }
    // === نهاية: الكود المصحح ===
    
    targetElement.appendChild(cvContentDiv);

    // --- 4. استدعاء دوال التنسيق والتحديث بعد بناء الهيكل ---
    saveCvDataToLocalStorage();
    applySelectedFonts();
    applySelectedColors();
    applyDynamicSizes();
}



function createEndMarkerHTML() {
    const endText = translations[currentLang]["End of CV"] || (currentLang === 'ar' ? "نهاية السيرة" : "End of CV");
    return `<div class="cv-end-marker" style="height:279mm!important;margin-top:auto!important;visibility:hidden!important;font-size:1px;color:transparent;">${endText}</div>`;
}

function updateProgress() {
    const progressBar = document.getElementById('progressBar');
    if (!progressBar) return;

    const nameInput = document.getElementById('name-input');
    const titleInput = document.getElementById('title-input');
    const emailInput = document.getElementById('email-input');
    const phoneInput = document.getElementById('phone-input');
    const websiteInput = document.getElementById('website-input');
    const objectiveInput = document.getElementById('objective-input');
    const profilePicInput = document.getElementById('profile-pic-input');

    let filledCoreFields = 0;
    if (nameInput && nameInput.value.trim()) filledCoreFields++;
    if (titleInput && titleInput.value.trim()) filledCoreFields++;
    if (emailInput && emailInput.value.trim()) filledCoreFields++;
    if (phoneInput && phoneInput.value.trim()) filledCoreFields++;
    if (websiteInput && websiteInput.value.trim()) filledCoreFields++;
    if (objectiveInput && objectiveInput.value.trim()) filledCoreFields++;
    if (profilePicInput && profilePicInput.files && profilePicInput.files.length > 0) filledCoreFields++;
    const totalCoreFields = 7;
    const coreFieldsWeight = 6;

    const sections = ['experience', 'education', 'skills', 'languages', 'references'];
    let filledSectionsCount = 0;
    sections.forEach(sectionId => {
        const sectionContainer = document.getElementById(`${sectionId}-input`);
        if (sectionContainer) {
            const inputs = sectionContainer.querySelectorAll('input, textarea');
            if (Array.from(inputs).some(input => input.value.trim() !== '')) {
                filledSectionsCount++;
            }
        }
    });
    const totalSections = sections.length;
    const sectionsOverallWeight = 4;

    let currentWeight = 0;
    if (totalCoreFields > 0) currentWeight += (filledCoreFields / totalCoreFields) * coreFieldsWeight;
    if (totalSections > 0) currentWeight += (filledSectionsCount / totalSections) * sectionsOverallWeight;
    
    const progress = Math.min(100, Math.round(currentWeight * 10));

    progressBar.style.width = `${progress}%`;
    progressBar.textContent = `${progress}%`;
    if (progress < 30) progressBar.style.backgroundColor = '#dc3545';
    else if (progress < 70) progressBar.style.backgroundColor = '#ffc107';
    else progressBar.style.backgroundColor = '#28a745';
}



// 1. الدالة النهائية للتحكم بالتنزيل المجاني
async function handleFreeCvDownload() {
    const freeCard = document.getElementById('free-cv-card');
    const originalText = freeCard.innerHTML;
    const email = document.getElementById('email-input')?.value.trim();

    if (!validateEmail(email)) {
        alert(currentLang === 'ar' ? 'الرجاء إدخال بريد إلكتروني صالح أولاً للمتابعة.' : 'Please enter a valid email to continue.');
        return;
    }

    // تغيير شكل البطاقة للإشارة إلى التحميل
    freeCard.innerHTML = `<div class="spinner-border spinner-border-sm" role="status"></div><span class="ms-2">${currentLang === 'ar' ? 'جاري المعالجة...' : 'Processing...'}</span>`;
    freeCard.style.pointerEvents = 'none'; // تعطيل الزر مؤقتاً

    try {
        // توليد الـ PDF أولاً
        const pdfData = await generatePdfFromNode(true); // true = بدون علامة مائية
        if (!pdfData || !pdfData.base64Pdf) {
            throw new Error("Failed to generate PDF before submission.");
        }

        // إرسال الطلب إلى doPost للتحقق والتسجيل
        // sendPaymentDataToAppsScript هي الدالة التي تقوم ببناء الطلب وإرساله إلى doPost
        // سنمرر لها 'FREECV' كطريقة دفع وسعر 0
        const success = await sendPaymentDataToAppsScript('FREECV Payment', 0, pdfData.base64Pdf, null);

        if (success) {
            // إذا نجحت العملية (تم التحقق والتسجيل)، ابدأ التنزيل
            const blob = base64toBlob(pdfData.base64Pdf, 'application/pdf');
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `CV_${document.getElementById('name-input')?.value.replace(/\s/g, '_') || 'ResailCV'}.pdf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showPage('thank-you-page'); // الانتقال لصفحة الشكر
        }
        // إذا لم تكن العملية ناجحة، فإن دالة sendPaymentDataToAppsScript ستكون قد عرضت رسالة الخطأ بالفعل

    } catch (error) {
        console.error("Free CV Download Error:", error);
        alert("Error: " + error.message);
    } finally {
        // إعادة البطاقة لحالتها الأصلية في جميع الأحوال
        freeCard.innerHTML = originalText;
        freeCard.style.pointerEvents = 'auto';
    }
}

document.querySelector('#cv-preview-page .btn-info.ms-3').onclick = async function() {
    const pdfData = await generatePdfFromNode(false); // isPaid: false -> مع علامة مائية
    if (pdfData && pdfData.base64Pdf) {
        const blob = base64toBlob(pdfData.base64Pdf, 'application/pdf');
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `CV_${document.getElementById('name-input')?.value.replace(/\s/g, '_') || 'ResailCV'}.pdf`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert(translations[currentLang]['CV downloaded successfully!']);
    } else {
        // رسالة الخطأ يتم عرضها بالفعل داخل generatePdfFromNode
    }
};

// هذا الزر في صفحة المعاينة (طلب تنزيل / طباعة)
document.querySelector('#cv-preview-page .btn-success.ms-3').onclick = function() {
    openPaymentForCV_appsScript(); // هذا سيؤدي إلى صفحة خيارات الدفع
};

/**
 * تبدأ العداد التنازلي وتحدثه كل ثانية في الواجهة الأمامية.
 * @param {string} isoEndDateString - تاريخ الانتهاء بصيغة ISO (مثل: "2025-12-31T23:59:59.000Z").
 */
function startCountdown(isoEndDateString) {
    const countdownElement = document.getElementById('countdown-timer');
    if (!countdownElement) return;

    const endTime = new Date(isoEndDateString).getTime();

    const timerInterval = setInterval(() => {
        const now = new Date().getTime();
        const distance = endTime - now;

        if (distance < 0) {
            clearInterval(timerInterval);
            countdownElement.textContent = translations[currentLang]?.['offer_expired'] || 'Offer Expired';
            countdownElement.classList.remove('blinking-code');
            return;
        }

        // حسابات الوقت
        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);

        // تنسيق الوقت لإضافة صفر في البداية إذا كان الرقم أقل من 10
        const fHours = hours < 10 ? '0' + hours : hours;
        const fMinutes = minutes < 10 ? '0' + minutes : minutes;
        const fSeconds = seconds < 10 ? '0' + seconds : seconds;
        
        let displayString = '';
        if (days > 0) {
            const dayText = translations[currentLang]?.['days'] || 'd';
            displayString += `${days}${dayText} ${fHours}:${fMinutes}:${fSeconds}`;
        } else {
            displayString = `${fHours}:${fMinutes}:${fSeconds}`;
        }

        countdownElement.textContent = displayString;

    }, 1000);
}


/**
 * تجلب إعدادات المؤقت من Google Apps Script وتبدأ العداد.
 */
async function initializeCountdown() {
    try {
        const response = await fetch(`${GOOGLE_APPS_SCRIPT_WEB_APP_URL_PAYMENT_PROCESSOR}?action=getTimerConfig`);
        if (!response.ok) throw new Error('Network response was not ok for timer config.');
        
        const data = await response.json();
        if (data.status === 'success' && data.endDate) {
            startCountdown(data.endDate);
        } else {
            console.error('Failed to get timer config:', data.message);
            const countdownElement = document.getElementById('countdown-timer');
            if(countdownElement) countdownElement.style.display = 'none';
        }
    } catch (error) {
        console.error('Error fetching timer config:', error);
        const countdownElement = document.getElementById('countdown-timer');
        if(countdownElement) countdownElement.style.display = 'none'; // إخفاء المؤقت عند حدوث خطأ
    }
}

/**
 * يتحكم في إظهار وإخفاء زر "ابدأ الآن" العائم بناءً على موضع التمرير.
 */
function handleFloatingButtonVisibility() {
    const header = document.querySelector('.site-header');
    const floatingBtn = document.getElementById('floating-cta-btn');
    // -->> السطر الجديد: نتحقق من الصفحة النشطة
    const isLandingPageActive = document.getElementById('landing-page').classList.contains('active-page');

    if (!header || !floatingBtn) return;

    const headerHeight = header.offsetHeight;

    // -->> الشرط الجديد: يجب أن يكون المستخدم قد تجاوز الهيدر **و** أن تكون الصفحة الرئيسية هي النشطة
    if (window.scrollY > headerHeight && isLandingPageActive) {
        floatingBtn.classList.add('show');
    } else {
        floatingBtn.classList.remove('show');
    }
}

/* ============================================= */
/* == كود إغلاق قائمة النافبار تلقائياً (في الجوال) == */
/* ============================================= */
document.addEventListener('DOMContentLoaded', () => {
    const navLinks = document.querySelectorAll('#navbarNav .nav-link');
    const navCollapse = document.getElementById('navbarNav');
    const bsCollapse = new bootstrap.Collapse(navCollapse, {
      toggle: false // مهم: لا تقم بتبديل الحالة عند الإنشاء
    });

    // 1. الإغلاق عند الضغط على أحد الروابط
    navLinks.forEach((link) => {
        link.addEventListener('click', () => {
            // تحقق مما إذا كانت القائمة مفتوحة (مرئية)
            if (navCollapse.classList.contains('show')) {
                bsCollapse.hide();
            }
        });
    });

    // 2. الإغلاق عند الضغط خارج القائمة
    document.addEventListener('click', (event) => {
        const isClickInsideNav = navCollapse.contains(event.target);
        const isToggler = event.target.closest('.navbar-toggler');

        // إذا كانت القائمة مفتوحة، والضغط كان خارجها، ولم يكن على زر الفتح/الإغلاق
        if (navCollapse.classList.contains('show') && !isClickInsideNav && !isToggler) {
            bsCollapse.hide();
        }
    });
});

function setupZoomControls() {
    const zoomBtn = document.getElementById('zoom-btn');
    const cvContainer = document.getElementById('cv-container');
    if (zoomBtn && cvContainer) {
        zoomBtn.addEventListener('click', () => {
            cvContainer.classList.toggle('zoomed-in');
        });
    }
}

// ... أضف هذا مع المتغيرات في بداية الملف
let saveNotificationTimeout;

// ▼▼▼ دالة جديدة لإظهار الإشعار ▼▼▼
function showSaveNotification() {
    const notification = document.getElementById('save-notification');
    if (!notification) return;

    // تحديث النص بناءً على اللغة الحالية
    const message = notification.getAttribute(`data-${currentLang}`);
    notification.textContent = message;

    // إظهار الإشعار
    notification.classList.add('show');

    // مسح أي مؤقت سابق لمنع التداخل
    clearTimeout(saveNotificationTimeout);

    // إخفاء الإشعار بعد 2.5 ثانية
    saveNotificationTimeout = setTimeout(() => {
        notification.classList.remove('show');
    }, 2500);
}

/**
 * الدالة المركزية لتشغيل عملية توليد السيرة الذاتية بالذكاء الاصطناعي
 * @param {string} name - اسم المستخدم
 * @param {string} title - المسمى الوظيفي
 * @param {string} summary - نبذة المستخدم
 * @param {string} requestType - نوع الطلب ('initial' أو 'refinement')
 * @param {string} existingDataJSON - البيانات الحالية للمستخدم (في حالة التحسين)
 */
async function triggerAiGeneration(name, title, summary, requestType = 'initial', existingDataJSON = '') {
    if (!name || !title) {
        alert(translations[currentLang]['error_name_title_required']);
        return;
    }

    toggleLoadingOverlay(true, 'ai_generating_cv');

    try {
        const formData = new URLSearchParams();
        formData.append('action', 'generateAiCv');
        formData.append('name', name);
        formData.append('jobTitle', title);
        formData.append('summary', summary);
        formData.append('language', currentLang);
        formData.append('requestType', requestType); // إرسال نوع الطلب
        if (requestType === 'refinement') {
            formData.append('existingData', existingDataJSON); // إرسال البيانات الحالية
        }

        const response = await fetch(GOOGLE_APPS_SCRIPT_WEB_APP_URL_PAYMENT_PROCESSOR, {
            method: 'POST',
            body: formData
        });

        const rawText = await response.text();
        if (!response.ok) {
            let serverError = rawText;
            try {
                serverError = JSON.parse(rawText).error || rawText;
            } catch (e) {}
            throw new Error(`Server error: ${response.status} - ${serverError}`);
        }

        const jsonMatch = rawText.match(/\{[\s\S]*\}/);
        if (!jsonMatch) throw new Error("Could not find a valid JSON object in the server response.");

        const aiData = JSON.parse(jsonMatch[0]);
        if (!aiData.candidates) throw new Error("AI response format is unexpected.");

        const parsedContent = JSON.parse(aiData.candidates[0].content.parts[0].text);
        
        // استخدام sessionStorage للتخزين المؤقت
        sessionStorage.setItem('aiCvData', JSON.stringify(parsedContent));
        sessionStorage.setItem('aiCvUserName', name);
        sessionStorage.setItem('aiCvUserTitle', title);

        // الانتقال لصفحة التعبئة
        showPage('cv-data-entry-page');

    } catch (error) {
        console.error(`ERROR in triggerAiGeneration (${requestType}):`, error);
        handleAiError(error);
    } finally {
        toggleLoadingOverlay(false);
    }
}

// استبدل الدالة بالكامل بهذه النسخة
function setupAiButtonListener() {
    const aiButton = document.getElementById('create-cv-button');
    const improveButton = document.getElementById('improve-cv-ai-btn'); 

    if (aiButton) {
        aiButton.addEventListener('click', () => {
            const savedData = localStorage.getItem('resailCvData_' + currentLang);
            if (savedData && Object.keys(JSON.parse(savedData)).length > 2) {
                showPage('cv-data-entry-page');
            } else {
                const name = document.getElementById('hero-name-input').value.trim();
                const title = document.getElementById('hero-title-input').value.trim();
                const summary = document.getElementById('hero-summary-input').value.trim();

                // ▼▼▼ شرط التحقق الجديد ▼▼▼
                if (!validateSummaryContainsEmail(summary)) {
                    alert(translations[currentLang]['summary_email_required']);
                    return; // إيقاف التنفيذ إذا لم يتم العثور على بريد إلكتروني
                }
                // ▲▲▲ نهاية شرط التحقق ▲▲▲

                triggerAiGeneration(name, title, summary, 'initial');
            }
        });
    }

    if (improveButton) {
        improveButton.addEventListener('click', () => {
            const currentData = collectCvData(); 
            const currentDataJson = JSON.stringify(currentData);
            triggerAiGeneration(currentData.name, currentData.jobTitle, currentData.objective, 'refinement', currentDataJson);
        });
    }
}

    // زر "تحسين بالذكاء الاصطناعي" داخل النموذج
    if (improveButton) {
        improveButton.addEventListener('click', () => {
            const currentData = collectCvData(); // جمع البيانات الحالية
            const currentDataJson = JSON.stringify(currentData);
            // شغل الذكاء الاصطناعي مع إرسال البيانات الحالية للتحسين
            triggerAiGeneration(currentData.name, currentData.jobTitle, currentData.objective, 'refinement', currentDataJson);
        });
    }

    



// استبدل الدالة بالكامل بهذه النسخة
function setupModalButtonListener() {
    const modalGenerateBtn = document.getElementById('modal-generate-btn');
    if (!modalGenerateBtn) return;

    modalGenerateBtn.addEventListener('click', () => {
        const savedData = localStorage.getItem('resailCvData_' + currentLang);
        if (savedData && Object.keys(JSON.parse(savedData)).length > 2) {
            const confirmationMessage = currentLang === 'ar'
                ? 'لديك سيرة ذاتية محفوظة. هل تريد حقاً إنشاء واحدة جديدة وحذف القديمة؟'
                : 'You have a saved CV. Do you really want to create a new one and overwrite the old one?';
            if (!confirm(confirmationMessage)) {
                return; 
            }
        }

        const name = document.getElementById('modal-name-input').value.trim();
        const title = document.getElementById('modal-title-input').value.trim();
        const summary = document.getElementById('modal-summary-input').value.trim();

        // ▼▼▼ شرط التحقق الجديد ▼▼▼
        if (!validateSummaryContainsEmail(summary)) {
            alert(translations[currentLang]['summary_email_required']);
            return; // إيقاف التنفيذ إذا لم يتم العثور على بريد إلكتروني
        }
        // ▲▲▲ نهاية شرط التحقق ▲▲▲

        const modalElement = document.getElementById('ai-prompt-modal');
        const modalInstance = bootstrap.Modal.getInstance(modalElement);
        if(modalInstance) {
            modalInstance.hide();
        }

        triggerAiGeneration(name, title, summary, 'initial');
    });
}
/**
 * =========================================================================
 * == (النسخة النهائية) تنشئ وتعبئ قسماً مخصصاً من بيانات الذكاء الاصطناعي ==
 * =========================================================================
 * @param {object} sectionData - The custom section object from the AI.
 */
function addCustomSectionFromAI(sectionData) {
    let customSectionsContainer = document.getElementById('custom-sections-container');
    if (!customSectionsContainer) {
        customSectionsContainer = document.createElement('div');
        customSectionsContainer.id = 'custom-sections-container';
        const formNavigationButtons = document.getElementById('form-navigation-buttons');
        // التأكد من وجود العنصر قبل الإضافة لتجنب الأخطاء
        if(formNavigationButtons && formNavigationButtons.parentNode) {
            formNavigationButtons.parentNode.insertBefore(customSectionsContainer, formNavigationButtons);
        } else {
             // حل بديل إذا لم يتم العثور على العنصر المرجعي
            document.querySelector('#cv-data-entry-page .col-md-6:last-child').appendChild(customSectionsContainer);
        }
    }

    const sectionWrapper = document.createElement('div');
    sectionWrapper.className = 'custom-section-wrapper mb-3 p-3 border rounded';

    const titleInput = document.createElement('input');
    titleInput.type = 'text';
    titleInput.value = sectionData.title || '';
    titleInput.className = 'form-control form-control-lg mb-2 custom-section-title';
    titleInput.oninput = () => generateCV(document.getElementById('cv-container'));

    const subSectionsContainer = document.createElement('div');
    subSectionsContainer.className = 'sub-sections-container';

    // تعبئة العناوين الفرعية من بيانات الذكاء الاصطناعي
    if (sectionData.subSections && Array.isArray(sectionData.subSections)) {
        sectionData.subSections.forEach(subData => {
            const subSectionEntry = document.createElement('div');
            subSectionEntry.className = 'custom-subsection-entry border p-2 mb-2 rounded position-relative';
            const subTitle = subData.title || '';
            const subDescription = subData.description || '';
            subSectionEntry.innerHTML = `
                <button type="button" class="remove-field" onclick="this.parentElement.remove(); generateCV(document.getElementById('cv-container'));" title="${translations[currentLang]['remove_subsection_title']}">&times;</button>
                <input type="text" class="form-control mb-2 custom-subsection-title" placeholder="${translations[currentLang]['subsection_title_placeholder']}" value="${subTitle}" oninput="generateCV(document.getElementById('cv-container'));">
                <textarea class="form-control custom-subsection-description" placeholder="${translations[currentLang]['subsection_desc_placeholder']}" rows="3" oninput="generateCV(document.getElementById('cv-container'));">${subDescription}</textarea>
            `;
            subSectionsContainer.appendChild(subSectionEntry);
        });
    }

    // --- ▼▼▼ الجزء الجديد والمهم: إضافة أزرار التحكم ▼▼▼ ---
    const buttonContainer = document.createElement('div');
    buttonContainer.className = 'mt-2';

    // زر "إضافة عنوان فرعي"
    const addSubSectionButton = document.createElement('button');
    addSubSectionButton.type = 'button';
    addSubSectionButton.className = 'btn btn-sm btn-outline-primary me-2';
    addSubSectionButton.innerHTML = translations[currentLang].add_subsection_btn;
    addSubSectionButton.onclick = function() {
        const subSectionEntry = document.createElement('div');
        subSectionEntry.className = 'custom-subsection-entry border p-2 mb-2 rounded position-relative';
        subSectionEntry.innerHTML = `
            <button type="button" class="remove-field" onclick="this.parentElement.remove(); generateCV(document.getElementById('cv-container'));" title="${translations[currentLang]['remove_subsection_title']}">&times;</button>
            <input type="text" class="form-control mb-2 custom-subsection-title" placeholder="${translations[currentLang]['subsection_title_placeholder']}" oninput="generateCV(document.getElementById('cv-container'));">
            <textarea class="form-control custom-subsection-description" placeholder="${translations[currentLang]['subsection_desc_placeholder']}" rows="3" oninput="generateCV(document.getElementById('cv-container'));"></textarea>
        `;
        subSectionsContainer.appendChild(subSectionEntry);
    };

    // زر "حذف القسم بالكامل"
    const removeSectionButton = document.createElement('button');
    removeSectionButton.type = 'button';
    removeSectionButton.className = 'btn btn-sm btn-danger';
    removeSectionButton.textContent = translations[currentLang].remove_section_btn;
    removeSectionButton.onclick = function() {
        if (confirm(translations[currentLang].confirm_delete_section)) {
            sectionWrapper.remove();
            generateCV(document.getElementById('cv-container'));
        }
    };

    buttonContainer.appendChild(addSubSectionButton);
    buttonContainer.appendChild(removeSectionButton);
    // --- ▲▲▲ نهاية الجزء الجديد ▲▲▲ ---

    sectionWrapper.appendChild(titleInput);
    sectionWrapper.appendChild(subSectionsContainer);
    sectionWrapper.appendChild(buttonContainer); // إضافة حاوية الأزرار إلى القسم

    customSectionsContainer.appendChild(sectionWrapper);
}
/**
 * Handles errors from the AI fetch process and displays a user-friendly message.
 * @param {Error} error - The error object caught in the try...catch block.
 */
function handleAiError(error) {
    let messageKey = 'ai_error_generic'; // الرسالة الافتراضية

    if (error.message.includes('Failed to fetch')) {
        messageKey = 'ai_error_network';
    } else if (error.message.includes('429')) { // خطأ تجاوز الحد المسموح به
        messageKey = 'ai_error_ratelimit';
    } else if (error.message.toLowerCase().includes('json')) {
        messageKey = 'ai_error_parsing';
    }
    
    // عرض الرسالة المترجمة للمستخدم
    alert(translations[currentLang][messageKey]);
}


function loadFontCss(fontFileName) {
    const cssFileUrl = `font-styles/${fontFileName}.css`;

    // تحقق إذا كان ملف الخط تم تحميله من قبل لتجنب تكرار التحميل
    if (!document.querySelector(`link[href="${cssFileUrl}"]`)) {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = cssFileUrl;
        document.head.appendChild(link);
        console.log(`Loading ${fontFileName} font...`);
    }
}
/**
 * دالة مساعدة لمسح جميع حقول النموذج والبيانات.
 */
function clearAllCvFields() {
    // مسح حقول الإدخال الأساسية
    document.getElementById('name-input').value = '';
    document.getElementById('title-input').value = '';
    document.getElementById('email-input').value = '';
    document.getElementById('phone-input').value = '';
    document.getElementById('website-input').value = '';
    document.getElementById('objective-input').value = '';
    profilePicDataUrl = null; // مسح الصورة
    document.getElementById('profile-pic-preview').style.display = 'none';
    document.getElementById('file-name-display').textContent = '';

    // مسح الحقول الديناميكية (الخبرات، التعليم، إلخ)
    ['experience-input', 'education-input', 'skills-input', 'languages-input', 'references-input'].forEach(id => {
        const container = document.getElementById(id);
        if (container) container.innerHTML = '';
    });
    
    // مسح الأقسام المخصصة
    const customContainer = document.getElementById('custom-sections-container');
    if (customContainer) customContainer.remove();
}

/**
 * دالة "البدء من جديد" التي سيتم ربطها بالزر الجديد.
 */
function handleStartOver() {
    const confirmationMessage = currentLang === 'ar' 
        ? 'هل أنت متأكد أنك تريد حذف جميع البيانات والبدء من جديد؟ لا يمكن التراجع عن هذا الإجراء.'
        : 'Are you sure you want to delete all data and start over? This action cannot be undone.';
    
    if (confirm(confirmationMessage)) {
        // 1. مسح البيانات الدائمة من الذاكرة
        localStorage.removeItem('resailCvData_' + currentLang);
        
        // 2. مسح الحقول في الواجهة الأمامية
        clearAllCvFields();
        
        // 3. (اختياري لكن موصى به) تعبئة النموذج ببيانات تجريبية جديدة

        
        // 4. تحديث المعاينة وشريط التقدم
        generateCV(document.getElementById('cv-container'));
        updateProgress();

        alert(currentLang === 'ar' ? 'تم مسح البيانات. يمكنك الآن البدء من جديد.' : 'Data cleared. You can now start over.');
    }
}

function validateSummaryContainsEmail(text) {
    if (!text || text.trim() === '') {
        return false;
    }
    // تعبير نمطي للبحث عن نمط البريد الإلكتروني داخل سلسلة نصية
    const emailRegex = /[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}/;
    return emailRegex.test(text);
}


/**
 * دالة مساعدة لقراءة قيمة كوكي معين بالاسم.
 * @param {string} name - اسم الكوكي (مثل '_fbp' أو '_fbc').
 * @returns {string|undefined} - قيمة الكوكي أو undefined إذا لم يتم العثور عليه.
 */
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}








